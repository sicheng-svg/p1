# Redis ä» 0 åˆ°ç²¾é€šå­¦ä¹ æ‰‹å†Œ

> ä½œè€…å®šä½ï¼šæœ¬æ‰‹å†Œé¢å‘åç«¯æ–°æ‰‹ï¼Œä»¥ C++ è§†è§’è¾…åŠ©ç†è§£ï¼Œä»å®‰è£…é…ç½®åˆ°é«˜çº§ç‰¹æ€§ï¼Œå†åˆ°å®æˆ˜åœºæ™¯ä¸é¢è¯•é¢˜ï¼Œå¾ªåºæ¸è¿›ï¼Œå…¨é¢è¦†ç›–ã€‚

---

## ç›®å½•

1. [Redis ç®€ä»‹ä¸æ ¸å¿ƒæ¦‚å¿µ](#1-redis-ç®€ä»‹ä¸æ ¸å¿ƒæ¦‚å¿µ)
2. [å®‰è£…ä¸é…ç½®](#2-å®‰è£…ä¸é…ç½®)
3. [æ•°æ®ç±»å‹è¯¦è§£](#3-æ•°æ®ç±»å‹è¯¦è§£)
4. [å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥](#4-å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥)
5. [æŒä¹…åŒ–æœºåˆ¶](#5-æŒä¹…åŒ–æœºåˆ¶)
6. [äº‹åŠ¡ä¸è„šæœ¬](#6-äº‹åŠ¡ä¸è„šæœ¬)
7. [å‘å¸ƒè®¢é˜…ï¼ˆPub/Subï¼‰](#7-å‘å¸ƒè®¢é˜…pubsub)
8. [è¿‡æœŸç­–ç•¥ä¸å†…å­˜æ·˜æ±°](#8-è¿‡æœŸç­–ç•¥ä¸å†…å­˜æ·˜æ±°)
9. [Redis é«˜å¯ç”¨æ¶æ„](#9-redis-é«˜å¯ç”¨æ¶æ„)
10. [Redis é›†ç¾¤ï¼ˆClusterï¼‰](#10-redis-é›†ç¾¤cluster)
11. [Redis + MySQL å®æˆ˜è®¾è®¡æ¨¡å¼](#11-redis--mysql-å®æˆ˜è®¾è®¡æ¨¡å¼)
12. [é«˜ QPS åœºæ™¯ä¸‹çš„ Redis å®è·µ](#12-é«˜-qps-åœºæ™¯ä¸‹çš„-redis-å®è·µ)
13. [C++ å®¢æˆ·ç«¯ä½¿ç”¨ï¼ˆhiredisï¼‰](#13-c-å®¢æˆ·ç«¯ä½¿ç”¨hiredis)
14. [Redis å®‰å…¨ä¸è¿ç»´](#14-redis-å®‰å…¨ä¸è¿ç»´)
15. [Redis é¢è¯•é¢˜ç²¾é€‰](#15-redis-é¢è¯•é¢˜ç²¾é€‰)

---

## 1. Redis ç®€ä»‹ä¸æ ¸å¿ƒæ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯ Redisï¼Ÿ

Redisï¼ˆ**Re**mote **Di**ctionary **S**erverï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„ã€åŸºäºå†…å­˜çš„é”®å€¼å­˜å‚¨æ•°æ®åº“ã€‚å®ƒæ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œå…·å¤‡æŒä¹…åŒ–èƒ½åŠ›ï¼Œè¢«å¹¿æ³›åº”ç”¨äºç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ’è¡Œæ¦œã€åˆ†å¸ƒå¼é”ç­‰åœºæ™¯ã€‚

```
+------------------+        ç½‘ç»œè¯·æ±‚        +------------------+
|   ä½ çš„åº”ç”¨ç¨‹åº    |  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   |   Redis Server   |
|  (C++ / Java /   |  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   |  (å•çº¿ç¨‹äº‹ä»¶å¾ªç¯) |
|   Python ...)    |        å“åº”æ•°æ®        |   æ•°æ®å­˜åœ¨å†…å­˜ä¸­  |
+------------------+                        +------------------+
```

### 1.2 ä¸ºä»€ä¹ˆ Redis è¿™ä¹ˆå¿«ï¼Ÿ

| åŸå›  | è¯´æ˜ |
|------|------|
| çº¯å†…å­˜æ“ä½œ | æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™é€Ÿåº¦æå¿«ï¼ˆns çº§åˆ«ï¼‰ |
| å•çº¿ç¨‹æ¨¡å‹ | å‘½ä»¤æ‰§è¡Œä¸²è¡ŒåŒ–ï¼Œé¿å…äº†é”ç«äº‰å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ |
| é«˜æ•ˆçš„æ•°æ®ç»“æ„ | åº•å±‚ä½¿ç”¨è·³è¡¨ã€å‹ç¼©åˆ—è¡¨ã€å“ˆå¸Œè¡¨ç­‰é«˜æ•ˆç»“æ„ |
| IO å¤šè·¯å¤ç”¨ | ä½¿ç”¨ epoll/kqueue å¤„ç†å¤§é‡å¹¶å‘è¿æ¥ |
| ç®€å•çš„ç½‘ç»œåè®® | RESP åè®®ç®€å•é«˜æ•ˆï¼Œè§£æå¼€é”€æä½ |

> **ç±»æ¯” C++**ï¼šRedis çš„å•çº¿ç¨‹æ¨¡å‹å°±åƒä½ å†™äº†ä¸€ä¸ª `while(true)` çš„äº‹ä»¶å¾ªç¯ï¼Œæ‰€æœ‰è¯·æ±‚ä¸²è¡Œå¤„ç†ï¼Œä½†å› ä¸ºæ¯ä¸ªæ“ä½œè€—æ—¶æçŸ­ï¼ˆå¾®ç§’çº§ï¼‰ï¼Œæ•´ä½“ååé‡ä¾ç„¶æé«˜ã€‚

### 1.3 Redis vs MySQL çš„å®šä½

```
è¯·æ±‚è¿›æ¥
   â”‚
   â–¼
[Redis ç¼“å­˜å±‚]  â”€â”€å‘½ä¸­â”€â”€â†’  ç›´æ¥è¿”å›ï¼ˆå¾®ç§’çº§ï¼‰
   â”‚
   â”‚ æœªå‘½ä¸­ï¼ˆCache Missï¼‰
   â–¼
[MySQL æŒä¹…å±‚]  â”€â”€æŸ¥è¯¢â”€â”€â†’  å†™å…¥ Redis â†’ è¿”å›ï¼ˆæ¯«ç§’çº§ï¼‰
```

Redis æ˜¯**ç¼“å­˜**ï¼ŒMySQL æ˜¯**æŒä¹…åŒ–å­˜å‚¨**ã€‚ä¸¤è€…ä¸æ˜¯æ›¿ä»£å…³ç³»ï¼Œè€Œæ˜¯åä½œå…³ç³»ã€‚

---

## 2. å®‰è£…ä¸é…ç½®

### 2.1 Linux å®‰è£…

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install redis-server

# CentOS/RHEL
sudo yum install epel-release
sudo yum install redis

# ä»æºç ç¼–è¯‘ï¼ˆæ¨èï¼Œå¯ä»¥æŒ‡å®šç‰ˆæœ¬ï¼‰
wget https://download.redis.io/releases/redis-7.2.0.tar.gz
tar xzf redis-7.2.0.tar.gz
cd redis-7.2.0
make
sudo make install
```

### 2.2 å¯åŠ¨ä¸è¿æ¥

```bash
# å¯åŠ¨ Redis æœåŠ¡
redis-server

# ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨
redis-server /etc/redis/redis.conf

# è¿æ¥ Redisï¼ˆå‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼‰
redis-cli

# æŒ‡å®š host å’Œ port
redis-cli -h 127.0.0.1 -p 6379

# å¸¦å¯†ç è¿æ¥
redis-cli -h 127.0.0.1 -p 6379 -a yourpassword
```

### 2.3 æ ¸å¿ƒé…ç½®æ–‡ä»¶ `redis.conf` è¯¦è§£

```ini
# ==================== ç½‘ç»œé…ç½® ====================
bind 127.0.0.1            # ç›‘å¬åœ°å€ï¼Œç”Ÿäº§ç¯å¢ƒä¸è¦ç”¨ 0.0.0.0
port 6379                 # ç›‘å¬ç«¯å£
protected-mode yes        # ä¿æŠ¤æ¨¡å¼ï¼Œæ— å¯†ç æ—¶ç¦æ­¢å¤–ç½‘è®¿é—®
tcp-backlog 511           # TCP è¿æ¥é˜Ÿåˆ—å¤§å°

# ==================== é€šç”¨é…ç½® ====================
daemonize yes             # ä»¥å®ˆæŠ¤è¿›ç¨‹è¿è¡Œ
pidfile /var/run/redis_6379.pid
loglevel notice           # æ—¥å¿—çº§åˆ«: debug/verbose/notice/warning
logfile /var/log/redis/redis-server.log
databases 16              # æ•°æ®åº“æ•°é‡ï¼Œé»˜è®¤ 16 ä¸ªï¼ˆ0-15ï¼‰

# ==================== å†…å­˜é…ç½® ====================
maxmemory 2gb             # æœ€å¤§å†…å­˜é™åˆ¶ï¼ˆç”Ÿäº§å¿…é¡»è®¾ç½®ï¼ï¼‰
maxmemory-policy allkeys-lru  # å†…å­˜æ·˜æ±°ç­–ç•¥

# ==================== æŒä¹…åŒ–é…ç½® ====================
# RDB
save 900 1                # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ–åˆ™ä¿å­˜
save 300 10               # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ–åˆ™ä¿å­˜
save 60 10000             # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ–åˆ™ä¿å­˜
dbfilename dump.rdb
dir /var/lib/redis

# AOF
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec      # æ¯ç§’åˆ·ç›˜

# ==================== å®‰å…¨é…ç½® ====================
requirepass yourStrongPassword123

# ==================== æ…¢æŸ¥è¯¢æ—¥å¿— ====================
slowlog-log-slower-than 10000  # è¶…è¿‡10msè®°å½•æ…¢æŸ¥è¯¢ï¼ˆå¾®ç§’å•ä½ï¼‰
slowlog-max-len 128
```

---

## 3. æ•°æ®ç±»å‹è¯¦è§£

Redis æœ‰ **5 ç§åŸºç¡€æ•°æ®ç±»å‹** + **3 ç§é«˜çº§æ•°æ®ç±»å‹**ã€‚

### 3.1 Stringï¼ˆå­—ç¬¦ä¸²ï¼‰

æœ€åŸºç¡€çš„ç±»å‹ï¼Œå¯ä»¥å­˜å‚¨å­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°ï¼Œæœ€å¤§ 512MBã€‚

**åº•å±‚ç¼–ç **ï¼š
- `int`ï¼šå€¼ä¸ºæ•´æ•°æ—¶
- `embstr`ï¼šå­—ç¬¦ä¸²é•¿åº¦ â‰¤ 44 å­—èŠ‚
- `raw`ï¼šå­—ç¬¦ä¸²é•¿åº¦ > 44 å­—èŠ‚

```bash
# åŸºæœ¬æ“ä½œ
SET key value               # è®¾ç½®
GET key                     # è·å–
DEL key                     # åˆ é™¤
EXISTS key                  # åˆ¤æ–­æ˜¯å¦å­˜åœ¨

# å¸¦è¿‡æœŸæ—¶é—´
SET key value EX 3600       # ç§’çº§è¿‡æœŸ
SET key value PX 3600000    # æ¯«ç§’çº§è¿‡æœŸ
SET key value EX 3600 NX    # ä¸å­˜åœ¨æ—¶æ‰è®¾ç½®ï¼ˆåˆ†å¸ƒå¼é”å¸¸ç”¨ï¼‰

# æ•°å€¼æ“ä½œ
INCR counter                # åŸå­è‡ªå¢ +1
INCRBY counter 5            # åŸå­è‡ªå¢ +5
DECR counter                # åŸå­è‡ªå‡ -1
DECRBY counter 3            # åŸå­è‡ªå‡ -3
INCRBYFLOAT price 9.9       # æµ®ç‚¹æ•°è‡ªå¢

# æ‰¹é‡æ“ä½œ
MSET k1 v1 k2 v2 k3 v3     # æ‰¹é‡è®¾ç½®
MGET k1 k2 k3               # æ‰¹é‡è·å–

# å…¶ä»–
STRLEN key                  # è·å–å­—ç¬¦ä¸²é•¿åº¦
APPEND key value            # è¿½åŠ å†…å®¹
GETSET key newvalue         # è®¾ç½®æ–°å€¼å¹¶è¿”å›æ—§å€¼
```

**å®æˆ˜åœºæ™¯**ï¼š
- ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆJSON å­—ç¬¦ä¸²ï¼‰
- è®¡æ•°å™¨ï¼ˆæ–‡ç« é˜…è¯»æ•°ã€ç‚¹èµæ•°ï¼‰
- åˆ†å¸ƒå¼é”ï¼ˆ`SET key value NX EX 30`ï¼‰
- Session å­˜å‚¨

---

### 3.2 Hashï¼ˆå“ˆå¸Œï¼‰

å­˜å‚¨é”®å€¼å¯¹çš„é›†åˆï¼Œç±»ä¼¼ C++ ä¸­çš„ `unordered_map<string, string>`ï¼Œéå¸¸é€‚åˆå­˜å‚¨å¯¹è±¡ã€‚

**åº•å±‚ç¼–ç **ï¼š
- `ziplist`ï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰ï¼šå­—æ®µæ•° â‰¤ 128 ä¸”å€¼é•¿åº¦ â‰¤ 64 å­—èŠ‚
- `hashtable`ï¼šè¶…è¿‡ä¸Šè¿°é˜ˆå€¼

```bash
# åŸºæœ¬æ“ä½œ
HSET user:1001 name "Alice" age 25 city "Beijing"  # è®¾ç½®å¤šä¸ªå­—æ®µï¼ˆRedis 4.0+ï¼‰
HGET user:1001 name          # è·å–å•ä¸ªå­—æ®µ
HMGET user:1001 name age     # æ‰¹é‡è·å–
HGETALL user:1001            # è·å–æ‰€æœ‰å­—æ®µå’Œå€¼
HKEYS user:1001              # è·å–æ‰€æœ‰å­—æ®µå
HVALS user:1001              # è·å–æ‰€æœ‰å€¼
HLEN user:1001               # è·å–å­—æ®µæ•°é‡

# ä¿®æ”¹ä¸åˆ é™¤
HDEL user:1001 city          # åˆ é™¤å­—æ®µ
HEXISTS user:1001 name       # åˆ¤æ–­å­—æ®µæ˜¯å¦å­˜åœ¨
HINCRBY user:1001 age 1      # æ•°å€¼å­—æ®µè‡ªå¢

# éå†ï¼ˆå¤§ Hash è¯·ç”¨ HSCANï¼Œé¿å…é˜»å¡ï¼‰
HSCAN user:1001 0 COUNT 10
```

**String vs Hash å­˜å‚¨ç”¨æˆ·å¯¹è±¡å¯¹æ¯”**ï¼š

```
String æ–¹æ¡ˆï¼š
  SET user:1001 '{"name":"Alice","age":25,"city":"Beijing"}'
  ç¼ºç‚¹ï¼šä¿®æ”¹ä¸€ä¸ªå­—æ®µéœ€è¦è¯»å‡ºæ•´ä¸ª JSONï¼Œä¿®æ”¹åå†å†™å›

Hash æ–¹æ¡ˆï¼š
  HSET user:1001 name "Alice" age 25 city "Beijing"
  ä¼˜ç‚¹ï¼šå¯ä»¥å•ç‹¬è¯»å†™æŸä¸ªå­—æ®µï¼Œæ›´æ–° age ä¸å½±å“å…¶ä»–å­—æ®µ
```

---

### 3.3 Listï¼ˆåˆ—è¡¨ï¼‰

æœ‰åºçš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œç±»ä¼¼ C++ çš„ `std::deque`ï¼Œæ”¯æŒä»ä¸¤ç«¯æ’å…¥/åˆ é™¤ã€‚

**åº•å±‚ç¼–ç **ï¼š
- `ziplist`ï¼šå…ƒç´ æ•°é‡å°‘ä¸”å…ƒç´ è¾ƒçŸ­æ—¶
- `quicklist`ï¼šå®é™…ä¸Šæ˜¯ç”± ziplist ç»„æˆçš„åŒå‘é“¾è¡¨ï¼ˆRedis 3.2+ï¼‰

```bash
# æ’å…¥
LPUSH mylist a b c           # ä»å·¦ç«¯æ’å…¥ï¼Œç»“æœï¼šc b a
RPUSH mylist x y z           # ä»å³ç«¯æ’å…¥ï¼Œç»“æœï¼šc b a x y z
LINSERT mylist BEFORE b "new"  # åœ¨ b ä¹‹å‰æ’å…¥

# åˆ é™¤
LPOP mylist                  # å¼¹å‡ºå·¦ç«¯å…ƒç´ 
RPOP mylist                  # å¼¹å‡ºå³ç«¯å…ƒç´ 
LPOP mylist 3                # å¼¹å‡ºå·¦ç«¯3ä¸ªå…ƒç´ ï¼ˆRedis 6.2+ï¼‰
LREM mylist 2 "a"            # åˆ é™¤2ä¸ªå€¼ä¸º"a"çš„å…ƒç´ ï¼ˆæ­£æ•°ä»å¤´åˆ ï¼Œè´Ÿæ•°ä»å°¾åˆ ï¼‰
LTRIM mylist 0 99            # ä¿ç•™ç´¢å¼•0-99ï¼Œå…¶ä½™åˆ é™¤

# æŸ¥è¯¢
LRANGE mylist 0 -1           # è·å–æ‰€æœ‰å…ƒç´ ï¼ˆ-1ä»£è¡¨æœ€åä¸€ä¸ªï¼‰
LINDEX mylist 0              # è·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´ 
LLEN mylist                  # è·å–åˆ—è¡¨é•¿åº¦

# é˜»å¡æ“ä½œï¼ˆæ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒï¼ï¼‰
BLPOP mylist 30              # é˜»å¡å·¦ç«¯å¼¹å‡ºï¼Œæœ€å¤šç­‰å¾…30ç§’
BRPOP mylist 30              # é˜»å¡å³ç«¯å¼¹å‡º

# ç”¨ä½œæ ˆï¼ˆå…ˆè¿›åå‡º LIFOï¼‰
LPUSH stack item1
LPUSH stack item2
LPOP stack   # å–å‡º item2

# ç”¨ä½œé˜Ÿåˆ—ï¼ˆå…ˆè¿›å…ˆå‡º FIFOï¼‰
RPUSH queue task1
RPUSH queue task2
LPOP queue   # å–å‡º task1
```

**å®æˆ˜åœºæ™¯**ï¼š
- æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆç”Ÿäº§è€… RPUSHï¼Œæ¶ˆè´¹è€… BLPOPï¼‰
- æœ€æ–°åŠ¨æ€åˆ—è¡¨ï¼ˆæœ‹å‹åœˆã€å¾®åšæ—¶é—´çº¿ï¼‰
- æ“ä½œå†å²è®°å½•ï¼ˆä¿ç•™æœ€è¿‘ N æ¡ï¼Œç”¨ LTRIMï¼‰

---

### 3.4 Setï¼ˆé›†åˆï¼‰

æ— åºçš„å­—ç¬¦ä¸²é›†åˆï¼Œå…ƒç´ å”¯ä¸€ï¼Œç±»ä¼¼ C++ çš„ `unordered_set<string>`ã€‚

**åº•å±‚ç¼–ç **ï¼š
- `intset`ï¼šæ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°ä¸”æ•°é‡ â‰¤ 512
- `hashtable`ï¼šå…¶ä»–æƒ…å†µ

```bash
# åŸºæœ¬æ“ä½œ
SADD tags "redis" "cache" "nosql"  # æ·»åŠ å…ƒç´ 
SREM tags "nosql"                   # åˆ é™¤å…ƒç´ 
SMEMBERS tags                       # è·å–æ‰€æœ‰å…ƒç´ ï¼ˆå°é›†åˆï¼‰
SISMEMBER tags "redis"              # åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨
SCARD tags                          # è·å–é›†åˆå¤§å°
SPOP tags                           # éšæœºå¼¹å‡ºä¸€ä¸ªå…ƒç´ 
SRANDMEMBER tags 3                  # éšæœºè¿”å›3ä¸ªå…ƒç´ ï¼ˆä¸åˆ é™¤ï¼‰

# é›†åˆè¿ç®—ï¼ˆå…±åŒå¥½å‹ã€å…±åŒå…³æ³¨ç­‰ï¼‰
SUNION set1 set2             # å¹¶é›†
SINTER set1 set2             # äº¤é›†
SDIFF set1 set2              # å·®é›†ï¼ˆset1 æœ‰ä½† set2 æ²¡æœ‰ï¼‰
SUNIONSTORE dest set1 set2   # å¹¶é›†ç»“æœå­˜å…¥ dest
SINTERSTORE dest set1 set2   # äº¤é›†ç»“æœå­˜å…¥ dest

# éå†å¤§é›†åˆ
SSCAN tags 0 COUNT 100
```

**å®æˆ˜åœºæ™¯**ï¼š
- æ ‡ç­¾ç³»ç»Ÿï¼ˆæ–‡ç« æ ‡ç­¾ã€ç”¨æˆ·æ ‡ç­¾ï¼‰
- å…±åŒå¥½å‹ã€å…±åŒå…³æ³¨ï¼ˆSINTERï¼‰
- å»é‡ç»Ÿè®¡ï¼ˆUV ç»Ÿè®¡ï¼‰
- æŠ½å¥–ï¼ˆSPOP æˆ– SRANDMEMBERï¼‰

---

### 3.5 ZSet / Sorted Setï¼ˆæœ‰åºé›†åˆï¼‰

å¸¦åˆ†æ•°ï¼ˆscoreï¼‰çš„æœ‰åºé›†åˆï¼Œå…ƒç´ å”¯ä¸€ä½† score å¯ä»¥é‡å¤ï¼ŒæŒ‰ score è‡ªåŠ¨æ’åºã€‚æ˜¯ Redis æœ€å¼ºå¤§çš„æ•°æ®ç»“æ„ä¹‹ä¸€ã€‚

**åº•å±‚ç¼–ç **ï¼š
- `ziplist`ï¼šå…ƒç´ æ•°é‡ â‰¤ 128 ä¸”å…ƒç´ é•¿åº¦ â‰¤ 64 å­—èŠ‚
- `skiplist`ï¼ˆè·³è¡¨ï¼‰+ `hashtable`ï¼šè¶…è¿‡ä¸Šè¿°é˜ˆå€¼

> **è·³è¡¨ï¼ˆSkip Listï¼‰**ï¼šå¹³å‡ O(log N) çš„æŸ¥æ‰¾/æ’å…¥/åˆ é™¤ï¼Œç±»ä¼¼äºå¤šå±‚çš„æœ‰åºé“¾è¡¨ã€‚

```bash
# åŸºæœ¬æ“ä½œ
ZADD ranking 100 "Alice" 95 "Bob" 88 "Charlie"  # æ·»åŠ 
ZSCORE ranking "Alice"          # è·å–åˆ†æ•°
ZRANK ranking "Bob"             # è·å–æ’åï¼ˆä»å°åˆ°å¤§ï¼Œ0å¼€å§‹ï¼‰
ZREVRANK ranking "Bob"          # è·å–æ’åï¼ˆä»å¤§åˆ°å°ï¼‰
ZCARD ranking                   # è·å–å…ƒç´ æ•°é‡
ZCOUNT ranking 90 100           # ç»Ÿè®¡åˆ†æ•°åœ¨[90,100]çš„å…ƒç´ æ•°

# èŒƒå›´æŸ¥è¯¢
ZRANGE ranking 0 -1             # æŒ‰æ’åå‡åºï¼ˆå…¨éƒ¨ï¼‰
ZREVRANGE ranking 0 -1          # æŒ‰æ’åé™åºï¼ˆå…¨éƒ¨ï¼‰
ZRANGE ranking 0 -1 WITHSCORES # å¸¦åˆ†æ•°è¿”å›
ZRANGEBYSCORE ranking 90 100    # æŒ‰åˆ†æ•°èŒƒå›´æŸ¥è¯¢ï¼ˆå‡åºï¼‰
ZREVRANGEBYSCORE ranking 100 90 # æŒ‰åˆ†æ•°èŒƒå›´æŸ¥è¯¢ï¼ˆé™åºï¼‰
ZRANGEBYLEX ranking "[A" "[C"   # æŒ‰å­—å…¸åºèŒƒå›´ï¼ˆåˆ†æ•°ç›¸åŒæ—¶ï¼‰

# ä¿®æ”¹ä¸åˆ é™¤
ZINCRBY ranking 5 "Charlie"     # åˆ†æ•°è‡ªå¢
ZREM ranking "Bob"              # åˆ é™¤å…ƒç´ 
ZREMRANGEBYRANK ranking 0 1     # æŒ‰æ’ååˆ é™¤
ZREMRANGEBYSCORE ranking 0 60   # æŒ‰åˆ†æ•°åˆ é™¤

# é›†åˆè¿ç®—
ZUNIONSTORE dest 2 z1 z2              # å¹¶é›†
ZINTERSTORE dest 2 z1 z2              # äº¤é›†
ZUNIONSTORE dest 2 z1 z2 WEIGHTS 2 1  # å¸¦æƒé‡
```

**å®æˆ˜åœºæ™¯**ï¼š
- æ’è¡Œæ¦œï¼ˆæ¸¸æˆç§¯åˆ†æ¦œã€çƒ­æœæ¦œï¼‰
- å¸¦æƒé‡çš„ä»»åŠ¡é˜Ÿåˆ—ï¼ˆscore ä¸ºæ‰§è¡Œæ—¶é—´ï¼Œå®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼‰
- æ»‘åŠ¨çª—å£é™æµï¼ˆscore ä¸ºæ—¶é—´æˆ³ï¼‰

---

### 3.6 é«˜çº§æ•°æ®ç±»å‹

#### 3.6.1 Bitmapï¼ˆä½å›¾ï¼‰

æœ¬è´¨æ˜¯ Stringï¼Œä½†æä¾›æŒ‰ä½æ“ä½œçš„å‘½ä»¤ã€‚ç”¨æå°‘ç©ºé—´å­˜å‚¨å¤§é‡å¸ƒå°”å€¼ã€‚

```bash
# ç”¨æˆ·ç­¾åˆ°ï¼ˆuserId ä½œä¸ºåç§»é‡ï¼‰
SETBIT sign:2024-01 1001 1    # ç”¨æˆ·1001ä»Šå¤©ç­¾åˆ°
GETBIT sign:2024-01 1001      # æŸ¥è¯¢ç­¾åˆ°çŠ¶æ€
BITCOUNT sign:2024-01         # ç»Ÿè®¡æœ¬æœˆç­¾åˆ°æ€»æ¬¡æ•°
BITOP AND result sign:01 sign:02  # ä¸¤å¤©éƒ½ç­¾åˆ°çš„ç”¨æˆ·
```

**åœºæ™¯**ï¼šç”¨æˆ·ç­¾åˆ°ã€å¸ƒéš†è¿‡æ»¤å™¨ã€åœ¨çº¿çŠ¶æ€ç»Ÿè®¡ï¼ˆ1äº¿ç”¨æˆ·åªéœ€ 12.5MBï¼‰

#### 3.6.2 HyperLogLog

ç”¨æå°‘å†…å­˜ï¼ˆå›ºå®š 12KBï¼‰ç»Ÿè®¡ä¸é‡å¤å…ƒç´ çš„æ•°é‡ï¼ˆåŸºæ•°ï¼‰ï¼Œè¯¯å·®ç‡çº¦ 0.81%ã€‚

```bash
PFADD pv:page1 user1 user2 user3  # æ·»åŠ å…ƒç´ 
PFCOUNT pv:page1                   # ç»Ÿè®¡åŸºæ•°ï¼ˆUVï¼‰
PFMERGE total pv:page1 pv:page2    # åˆå¹¶å¤šä¸ª HyperLogLog
```

**åœºæ™¯**ï¼šUVï¼ˆç‹¬ç«‹è®¿å®¢ï¼‰ç»Ÿè®¡ï¼Œä¸éœ€è¦ç²¾ç¡®å€¼æ—¶ä½¿ç”¨ã€‚

#### 3.6.3 Geoï¼ˆåœ°ç†ä½ç½®ï¼‰

åŸºäº ZSet å®ç°ï¼Œå­˜å‚¨ç»çº¬åº¦å¹¶æä¾›è·ç¦»è®¡ç®—ã€èŒƒå›´æŸ¥è¯¢ã€‚

```bash
GEOADD locations 116.4 39.9 "Beijing" 121.4 31.2 "Shanghai"
GEOPOS locations "Beijing"                   # è·å–åæ ‡
GEODIST locations "Beijing" "Shanghai" km    # è®¡ç®—è·ç¦»
GEORADIUS locations 116.4 39.9 500 km        # æŸ¥æ‰¾500kmå†…çš„ä½ç½®
GEOSEARCH locations FROMMEMBER "Beijing" BYRADIUS 500 km ASC COUNT 5
```

**åœºæ™¯**ï¼šé™„è¿‘çš„äººã€é™„è¿‘çš„å•†å®¶ã€éª‘æ‰‹/å¸æœºä½ç½®

---

## 4. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

### 4.1 Key æ“ä½œ

```bash
KEYS pattern          # åŒ¹é…é”®ï¼ˆç”Ÿäº§ç¦ç”¨ï¼ä¼šé˜»å¡ï¼‰
SCAN 0 MATCH "user:*" COUNT 100  # å®‰å…¨éå†ï¼ˆæ¨èï¼‰
TYPE key              # è·å–é”®çš„æ•°æ®ç±»å‹
TTL key               # è·å–å‰©ä½™è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ-1æ°¸ä¸è¿‡æœŸï¼Œ-2ä¸å­˜åœ¨
PTTL key              # æ¯«ç§’çº§ TTL
EXPIRE key 3600       # è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
PEXPIRE key 3600000   # æ¯«ç§’çº§è¿‡æœŸ
PERSIST key           # ç§»é™¤è¿‡æœŸæ—¶é—´ï¼ˆæ°¸ä¹…ï¼‰
RENAME key newkey     # é‡å‘½å
MOVE key 1            # ç§»åŠ¨åˆ°æ•°æ®åº“1
DUMP key              # åºåˆ—åŒ–
OBJECT ENCODING key   # æŸ¥çœ‹åº•å±‚ç¼–ç 
OBJECT REFCOUNT key   # å¼•ç”¨è®¡æ•°
OBJECT IDLETIME key   # ç©ºé—²æ—¶é—´
```

### 4.2 æœåŠ¡å™¨å‘½ä»¤

```bash
PING                  # æµ‹è¯•è¿æ¥
INFO                  # æŸ¥çœ‹æœåŠ¡å™¨ä¿¡æ¯
INFO memory           # å†…å­˜ä¿¡æ¯
INFO replication      # ä¸»ä»ä¿¡æ¯
INFO stats            # ç»Ÿè®¡ä¿¡æ¯
DBSIZE                # å½“å‰æ•°æ®åº“ key æ•°é‡
SELECT 1              # åˆ‡æ¢æ•°æ®åº“ï¼ˆ0-15ï¼‰
FLUSHDB               # æ¸…ç©ºå½“å‰æ•°æ®åº“ï¼ˆå±é™©ï¼ï¼‰
FLUSHALL              # æ¸…ç©ºæ‰€æœ‰æ•°æ®åº“ï¼ˆéå¸¸å±é™©ï¼ï¼‰
CONFIG GET maxmemory  # è·å–é…ç½®
CONFIG SET maxmemory 2gb  # åŠ¨æ€ä¿®æ”¹é…ç½®
CONFIG REWRITE        # å°†é…ç½®å†™å›æ–‡ä»¶
DEBUG SLEEP 5         # è®©æœåŠ¡å™¨ç¡5ç§’ï¼ˆæµ‹è¯•ç”¨ï¼‰
SLOWLOG GET           # æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
MONITOR               # å®æ—¶ç›‘æ§æ‰€æœ‰å‘½ä»¤ï¼ˆè°ƒè¯•ç”¨ï¼‰
CLIENT LIST           # æŸ¥çœ‹æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
CLIENT KILL id 10     # æ–­å¼€æŒ‡å®šå®¢æˆ·ç«¯
```

---

## 5. æŒä¹…åŒ–æœºåˆ¶

Redis æä¾›ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ï¼Œç”Ÿäº§ç¯å¢ƒé€šå¸¸**åŒæ—¶å¼€å¯**ã€‚

### 5.1 RDBï¼ˆRedis Databaseï¼‰

**åŸç†**ï¼šåœ¨æŸä¸ªæ—¶é—´ç‚¹ï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®å¿«ç…§å†™å…¥ç£ç›˜ï¼ˆ.rdb æ–‡ä»¶ï¼‰ã€‚

```
Redis è¿›ç¨‹
    â”‚
    â”‚  fork() ç³»ç»Ÿè°ƒç”¨
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å­è¿›ç¨‹
    â”‚                          â”‚
    â”‚  ç»§ç»­å¤„ç†è¯·æ±‚              â”‚  å°†å†…å­˜æ•°æ®å†™å…¥ dump.rdb
    â”‚  ï¼ˆåˆ©ç”¨ COW æœºåˆ¶ï¼‰         â”‚
    â”‚                          â†“
    â”‚                    å†™å…¥å®Œæˆï¼Œæ›¿æ¢æ—§æ–‡ä»¶
```

**è§¦å‘æ–¹å¼**ï¼š
```bash
# 1. è‡ªåŠ¨è§¦å‘ï¼ˆé…ç½®æ–‡ä»¶ä¸­çš„ save è§„åˆ™ï¼‰
save 900 1
save 300 10
save 60 10000

# 2. æ‰‹åŠ¨è§¦å‘
BGSAVE       # å¼‚æ­¥ä¿å­˜ï¼ˆæ¨èï¼Œä¸é˜»å¡ï¼‰
SAVE         # åŒæ­¥ä¿å­˜ï¼ˆé˜»å¡ï¼Œç”Ÿäº§æ…ç”¨ï¼‰

# 3. SHUTDOWN æ—¶è‡ªåŠ¨ä¿å­˜
# 4. ä¸»ä»å¤åˆ¶æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼š BGSAVE
```

**ä¼˜ç‚¹**ï¼š
- æ–‡ä»¶ç´§å‡‘ï¼Œæ¢å¤é€Ÿåº¦å¿«
- é€‚åˆç¾éš¾æ¢å¤å’Œå¤‡ä»½
- fork åå¯¹ä¸»è¿›ç¨‹æ€§èƒ½å½±å“å°

**ç¼ºç‚¹**ï¼š
- æ•°æ®å¯èƒ½ä¸¢å¤±ï¼ˆä¸¤æ¬¡å¿«ç…§ä¹‹é—´çš„æ•°æ®ï¼‰
- fork å¤§å†…å­˜æ—¶å¯èƒ½å¡é¡¿ï¼ˆæ¯«ç§’~ç§’çº§ï¼‰

---

### 5.2 AOFï¼ˆAppend Only Fileï¼‰

**åŸç†**ï¼šå°†æ¯ä¸ªå†™å‘½ä»¤è¿½åŠ åˆ° .aof æ–‡ä»¶ä¸­ï¼Œç±»ä¼¼ MySQL çš„ binlogã€‚

```
å†™å‘½ä»¤ SET key value
    â”‚
    â–¼
æ‰§è¡Œå‘½ä»¤ï¼ˆä¿®æ”¹å†…å­˜ï¼‰
    â”‚
    â–¼
å°†å‘½ä»¤å†™å…¥ AOF ç¼“å†²åŒº
    â”‚
    â–¼ ï¼ˆæ ¹æ® appendfsync ç­–ç•¥ï¼‰
å†™å…¥ç£ç›˜ appendonly.aof
```

**ä¸‰ç§åŒæ­¥ç­–ç•¥**ï¼š

| ç­–ç•¥ | è¯´æ˜ | å®‰å…¨æ€§ | æ€§èƒ½ |
|------|------|--------|------|
| `always` | æ¯æ¬¡å†™å‘½ä»¤éƒ½ fsync | æœ€é«˜ï¼ˆä¸ä¸¢æ•°æ®ï¼‰ | æœ€ä½ |
| `everysec` | æ¯ç§’ fsync ä¸€æ¬¡ | é«˜ï¼ˆæœ€å¤šä¸¢1ç§’ï¼‰ | é«˜ï¼ˆ**æ¨è**ï¼‰ |
| `no` | ç”± OS å†³å®šä½•æ—¶ fsync | ä½ | æœ€é«˜ |

**AOF é‡å†™ï¼ˆRewriteï¼‰**ï¼š

AOF æ–‡ä»¶ä¼šéšæ—¶é—´å¢å¤§ï¼ŒRedis æä¾›é‡å†™æœºåˆ¶å‹ç¼©æ–‡ä»¶ï¼š

```bash
BGREWRITEAOF  # è§¦å‘åå°é‡å†™

# redis.conf ä¸­çš„è‡ªåŠ¨é‡å†™é…ç½®
auto-aof-rewrite-percentage 100   # æ–‡ä»¶å¤§å°æ¯”ä¸Šæ¬¡å¢é•¿100%æ—¶è§¦å‘
auto-aof-rewrite-min-size 64mb    # æ–‡ä»¶è‡³å°‘64mbæ‰è§¦å‘
```

é‡å†™è¿‡ç¨‹ï¼šfork å­è¿›ç¨‹ï¼Œæ ¹æ®å½“å‰å†…å­˜çŠ¶æ€é‡æ–°ç”Ÿæˆæœ€ç®€åŒ–çš„å‘½ä»¤é›†åˆï¼ˆä¾‹å¦‚ 100 æ¬¡ INCR åˆå¹¶ä¸ºä¸€æ¬¡ SETï¼‰ã€‚

---

### 5.3 RDB vs AOF å¯¹æ¯”

| å¯¹æ¯”é¡¹ | RDB | AOF |
|--------|-----|-----|
| æ•°æ®å®Œæ•´æ€§ | ä½ï¼ˆå¯èƒ½ä¸¢å¤±å‡ åˆ†é’Ÿæ•°æ®ï¼‰ | é«˜ï¼ˆæœ€å¤šä¸¢1ç§’ï¼‰ |
| æ–‡ä»¶å¤§å° | å°ï¼ˆå‹ç¼©äºŒè¿›åˆ¶ï¼‰ | å¤§ï¼ˆæ–‡æœ¬å‘½ä»¤ï¼‰ |
| æ¢å¤é€Ÿåº¦ | å¿« | æ…¢ |
| å¯¹æ€§èƒ½å½±å“ | fork æ—¶æœ‰çŸ­æš‚å½±å“ | æŒç»­è½»å¾®å½±å“ |
| é€‚ç”¨åœºæ™¯ | æ•°æ®å¤‡ä»½ã€å¯æ¥å—å°‘é‡ä¸¢å¤± | å¯¹æ•°æ®å®Œæ•´æ€§è¦æ±‚é«˜ |

**ç”Ÿäº§å»ºè®®**ï¼šåŒæ—¶å¼€å¯ RDB å’Œ AOFï¼ŒAOF ç”¨äºæ•°æ®æ¢å¤ï¼ŒRDB ç”¨äºå¤‡ä»½ã€‚

---

### 5.4 æ··åˆæŒä¹…åŒ–ï¼ˆRedis 4.0+ï¼‰

```ini
# redis.conf
aof-use-rdb-preamble yes  # å¼€å¯æ··åˆæŒä¹…åŒ–
```

AOF é‡å†™æ—¶ï¼Œå‰åŠéƒ¨åˆ†å†™ RDB æ ¼å¼ï¼ˆå¿«ï¼‰ï¼ŒååŠéƒ¨åˆ†å†™ AOF å¢é‡å‘½ä»¤ï¼Œå…¼é¡¾æ¢å¤é€Ÿåº¦å’Œæ•°æ®å®‰å…¨ã€‚

---

## 6. äº‹åŠ¡ä¸è„šæœ¬

### 6.1 Redis äº‹åŠ¡

Redis äº‹åŠ¡é€šè¿‡ `MULTI/EXEC/DISCARD/WATCH` å®ç°ï¼Œ**ä¸æ”¯æŒå›æ»š**ã€‚

```bash
MULTI          # å¼€å¯äº‹åŠ¡
SET k1 v1      # å‘½ä»¤å…¥é˜Ÿï¼ˆä¸ç«‹å³æ‰§è¡Œï¼‰
SET k2 v2      # å‘½ä»¤å…¥é˜Ÿ
INCR counter   # å‘½ä»¤å…¥é˜Ÿ
EXEC           # æ‰§è¡Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤
DISCARD        # å–æ¶ˆäº‹åŠ¡

# ç»“æœç¤ºä¾‹
1) OK
2) OK
3) (integer) 1
```

**æ³¨æ„äº‹é¡¹**ï¼š
- äº‹åŠ¡ä¸­çš„å‘½ä»¤å¦‚æœæœ‰**è¯­æ³•é”™è¯¯**ï¼ˆå¦‚å‘½ä»¤åæ‹¼é”™ï¼‰ï¼ŒEXEC æ—¶æ•´ä¸ªäº‹åŠ¡ä¸æ‰§è¡Œ
- äº‹åŠ¡ä¸­çš„å‘½ä»¤å¦‚æœæœ‰**è¿è¡Œé”™è¯¯**ï¼ˆå¦‚å¯¹ String åš LPUSHï¼‰ï¼Œå…¶ä»–å‘½ä»¤ä¾ç„¶æ‰§è¡Œï¼ˆä¸å›æ»šï¼ï¼‰
- Redis äº‹åŠ¡**ä¸æ˜¯åŸå­æ€§**çš„ï¼ˆä¸åƒ MySQL é‚£æ ·è¦ä¹ˆå…¨æˆåŠŸè¦ä¹ˆå…¨å¤±è´¥ï¼‰

### 6.2 WATCHï¼ˆä¹è§‚é”ï¼‰

```bash
WATCH balance            # ç›‘è§† balance é”®
# å¦‚æœåœ¨ MULTI ä¹‹å‰ balance è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹ï¼ŒEXEC è¿”å› nil
MULTI
DECRBY balance 100
INCRBY other_account 100
EXEC                     # å¦‚æœ balance è¢«ä¿®æ”¹ï¼Œè¿”å› nilï¼ˆäº‹åŠ¡å¤±è´¥ï¼‰
```

> **ç±»æ¯”**ï¼šWATCH å®ç°äº†ä¹è§‚é”ï¼ˆCAS æœºåˆ¶ï¼‰ï¼Œç±»ä¼¼ C++ ä¸­çš„ `compare_exchange_strong`ã€‚

### 6.3 Lua è„šæœ¬ï¼ˆçœŸæ­£çš„åŸå­æ€§ï¼‰

Lua è„šæœ¬åœ¨ Redis ä¸­æ˜¯**åŸå­æ‰§è¡Œ**çš„ï¼Œæ‰§è¡ŒæœŸé—´ä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ’å…¥ã€‚

```bash
# æ‰§è¡Œ Lua è„šæœ¬
EVAL "return redis.call('set', KEYS[1], ARGV[1])" 1 mykey myvalue

# ç¤ºä¾‹ï¼šåŸå­åŒ–çš„"æ£€æŸ¥å¹¶è®¾ç½®"
EVAL "
  local val = redis.call('get', KEYS[1])
  if val == ARGV[1] then
    return redis.call('del', KEYS[1])
  else
    return 0
  end
" 1 lockkey lockvalue
```

**åˆ†å¸ƒå¼é”é‡Šæ”¾çš„æ­£ç¡®å§¿åŠ¿**ï¼ˆä½¿ç”¨ Lua ä¿è¯åŸå­æ€§ï¼‰ï¼š

```lua
-- æ£€æŸ¥é”æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼Œæ˜¯çš„è¯æ‰é‡Šæ”¾
if redis.call('get', KEYS[1]) == ARGV[1] then
    return redis.call('del', KEYS[1])
else
    return 0
end
```

```bash
# åŠ è½½è„šæœ¬ï¼ˆè¿”å› SHA1ï¼‰
SCRIPT LOAD "return redis.call('get', KEYS[1])"
# é€šè¿‡ SHA1 è°ƒç”¨ï¼ˆé¿å…é‡å¤ä¼ è¾“è„šæœ¬ï¼‰
EVALSHA sha1å€¼ 1 mykey
```

---

## 7. å‘å¸ƒè®¢é˜…ï¼ˆPub/Subï¼‰

### 7.1 åŸºç¡€ Pub/Sub

```bash
# è®¢é˜…è€…
SUBSCRIBE channel1 channel2    # è®¢é˜…é¢‘é“
PSUBSCRIBE news.*              # æ¨¡å¼è®¢é˜…ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰

# å‘å¸ƒè€…
PUBLISH channel1 "Hello World" # å‘å¸ƒæ¶ˆæ¯ï¼ˆè¿”å›æ”¶åˆ°æ¶ˆæ¯çš„è®¢é˜…è€…æ•°ï¼‰

# ç®¡ç†
PUBSUB CHANNELS               # æŸ¥çœ‹æ´»è·ƒé¢‘é“
PUBSUB NUMSUB channel1        # æŸ¥çœ‹é¢‘é“è®¢é˜…æ•°
UNSUBSCRIBE channel1          # å–æ¶ˆè®¢é˜…
```

**ç¼ºç‚¹**ï¼šæ¶ˆæ¯ä¸æŒä¹…åŒ–ï¼Œè®¢é˜…è€…ç¦»çº¿ä¼šä¸¢å¤±æ¶ˆæ¯ã€‚

### 7.2 Streamï¼ˆRedis 5.0+ï¼ŒæŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—ï¼‰

Stream æ˜¯ Redis ä¸­åŠŸèƒ½æœ€å®Œæ•´çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç±»ä¼¼ Kafka çš„ç®€åŒ–ç‰ˆã€‚

```bash
# ç”Ÿäº§æ¶ˆæ¯ï¼ˆ* è¡¨ç¤ºè‡ªåŠ¨ç”Ÿæˆ IDï¼‰
XADD orders * product "iPhone" price 999 user "Alice"
# è¿”å› IDï¼Œæ ¼å¼ï¼šæ¯«ç§’æ—¶é—´æˆ³-åºå·ï¼Œå¦‚ 1699000000000-0

# æ¶ˆè´¹æ¶ˆæ¯
XREAD COUNT 10 STREAMS orders 0     # ä»å¤´è¯»å–10æ¡
XREAD COUNT 10 BLOCK 0 STREAMS orders $  # é˜»å¡ç­‰å¾…æ–°æ¶ˆæ¯

# æ¶ˆè´¹è€…ç»„ï¼ˆå¤šæ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡ï¼‰
XGROUP CREATE orders mygroup $ MKSTREAM  # åˆ›å»ºæ¶ˆè´¹è€…ç»„
XREADGROUP GROUP mygroup consumer1 COUNT 5 STREAMS orders >  # æ¶ˆè´¹
XACK orders mygroup messageId       # ç¡®è®¤æ¶ˆè´¹ï¼ˆACKï¼‰
XPENDING orders mygroup - + 10      # æŸ¥çœ‹æœª ACK çš„æ¶ˆæ¯
```

---

## 8. è¿‡æœŸç­–ç•¥ä¸å†…å­˜æ·˜æ±°

### 8.1 Key çš„è¿‡æœŸåˆ é™¤ç­–ç•¥

Redis ä½¿ç”¨ä¸¤ç§ç­–ç•¥ç»“åˆï¼š

**æƒ°æ€§åˆ é™¤ï¼ˆLazy Expirationï¼‰**ï¼š
- è®¿é—® key æ—¶æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸåˆ™åˆ é™¤
- ä¼˜ç‚¹ï¼šCPU å‹å¥½ï¼›ç¼ºç‚¹ï¼šè¿‡æœŸ key å¯èƒ½é•¿æœŸå ç”¨å†…å­˜

**å®šæœŸåˆ é™¤ï¼ˆPeriodic Expirationï¼‰**ï¼š
- æ¯ 100ms éšæœºæ£€æŸ¥ä¸€æ‰¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key
- è¶…è¿‡ 25% è¿‡æœŸåˆ™ç»§ç»­æ£€æŸ¥ï¼ˆè‡ªé€‚åº”é¢‘ç‡ï¼‰
- ä¼˜ç‚¹ï¼šå†…å­˜åˆ©ç”¨ç‡å¥½ï¼›ç¼ºç‚¹ï¼šæœ‰ CPU å¼€é”€

### 8.2 å†…å­˜æ·˜æ±°ç­–ç•¥ï¼ˆmaxmemory-policyï¼‰

å½“å†…å­˜è¾¾åˆ° `maxmemory` é™åˆ¶æ—¶ï¼ŒRedis ä¼šæŒ‰ç…§é…ç½®çš„ç­–ç•¥æ·˜æ±° keyï¼š

| ç­–ç•¥ | èŒƒå›´ | æ–¹å¼ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| `noeviction` | å…¨éƒ¨ | ä¸æ·˜æ±°ï¼Œè¿”å›é”™è¯¯ | ä¸å…è®¸ä¸¢æ•°æ®æ—¶ |
| `allkeys-lru` | å…¨éƒ¨ | æœ€è¿‘æœ€å°‘ä½¿ç”¨ | **é€šç”¨ç¼“å­˜ï¼ˆæœ€æ¨èï¼‰** |
| `allkeys-lfu` | å…¨éƒ¨ | æœ€ä¸ç»å¸¸ä½¿ç”¨ | è®¿é—®é¢‘ç‡å·®å¼‚å¤§æ—¶ |
| `allkeys-random` | å…¨éƒ¨ | éšæœºæ·˜æ±° | å‡åŒ€è®¿é—®æ—¶ |
| `volatile-lru` | æœ‰è¿‡æœŸæ—¶é—´çš„ | æœ€è¿‘æœ€å°‘ä½¿ç”¨ | éƒ¨åˆ†æ•°æ®å¿…é¡»ä¿ç•™æ—¶ |
| `volatile-lfu` | æœ‰è¿‡æœŸæ—¶é—´çš„ | æœ€ä¸ç»å¸¸ä½¿ç”¨ | åŒä¸Š |
| `volatile-random` | æœ‰è¿‡æœŸæ—¶é—´çš„ | éšæœºæ·˜æ±° | åŒä¸Š |
| `volatile-ttl` | æœ‰è¿‡æœŸæ—¶é—´çš„ | ä¼˜å…ˆæ·˜æ±°å¿«è¿‡æœŸçš„ | åŒä¸Š |

> **LRU vs LFU**ï¼šLRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰æ·˜æ±°æœ€ä¹…æ²¡è¢«è®¿é—®çš„ï¼›LFUï¼ˆæœ€ä¸ç»å¸¸ä½¿ç”¨ï¼‰æ·˜æ±°å†å²è®¿é—®æ¬¡æ•°æœ€å°‘çš„ã€‚å¯¹äºç¼“å­˜çƒ­ç‚¹æ•°æ®åœºæ™¯ï¼ŒLFU æ•ˆæœæ›´å¥½ã€‚

---

## 9. Redis é«˜å¯ç”¨æ¶æ„

### 9.1 ä¸»ä»å¤åˆ¶ï¼ˆReplicationï¼‰

```
ä¸»èŠ‚ç‚¹ (Master)  â”€â”€å¤åˆ¶â”€â”€â†’  ä»èŠ‚ç‚¹1 (Slave)
                 â”€â”€å¤åˆ¶â”€â”€â†’  ä»èŠ‚ç‚¹2 (Slave)
                 â”€â”€å¤åˆ¶â”€â”€â†’  ä»èŠ‚ç‚¹3 (Slave)
```

**é…ç½®ä»èŠ‚ç‚¹**ï¼š
```bash
# åœ¨ä»èŠ‚ç‚¹çš„ redis.conf ä¸­
replicaof 192.168.1.100 6379   # æŒ‡å®šä¸»èŠ‚ç‚¹
masterauth yourpassword         # ä¸»èŠ‚ç‚¹å¯†ç 

# æˆ–è¿è¡Œæ—¶åŠ¨æ€è®¾ç½®
REPLICAOF 192.168.1.100 6379
```

**å¤åˆ¶æµç¨‹**ï¼š
1. ä»èŠ‚ç‚¹å‘é€ `PSYNC` å‘½ä»¤
2. ä¸»èŠ‚ç‚¹æ‰§è¡Œ `BGSAVE` ç”Ÿæˆ RDB æ–‡ä»¶ï¼ŒåŒæ—¶ç¼“å†²æ–°å†™å‘½ä»¤
3. ä¸»èŠ‚ç‚¹å‘é€ RDB æ–‡ä»¶ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹åŠ è½½
4. ä¸»èŠ‚ç‚¹å‘é€ç¼“å†²çš„å†™å‘½ä»¤ï¼Œä»èŠ‚ç‚¹æ‰§è¡Œ
5. ä¹‹åå®æ—¶åŒæ­¥ï¼ˆä¸»èŠ‚ç‚¹å¼‚æ­¥å‘é€å†™å‘½ä»¤ç»™ä»èŠ‚ç‚¹ï¼‰

**ä¸»ä»å»¶è¿Ÿ**ï¼šä»èŠ‚ç‚¹æ˜¯å¼‚æ­¥å¤åˆ¶ï¼Œå­˜åœ¨æ¯«ç§’çº§å»¶è¿Ÿï¼Œè¯»ä»èŠ‚ç‚¹å¯èƒ½è¯»åˆ°æ—§æ•°æ®ï¼ˆ**ä¸»å†™ä»è¯»**æ¶æ„éœ€æ³¨æ„ï¼‰ã€‚

---

### 9.2 å“¨å…µæ¨¡å¼ï¼ˆSentinelï¼‰

è§£å†³ä¸»ä»æ¶æ„ä¸­**ä¸»èŠ‚ç‚¹æ•…éšœè‡ªåŠ¨åˆ‡æ¢**çš„é—®é¢˜ã€‚

```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Sentinel1  â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ ç›‘æ§
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               â”‚               â”‚
â–¼               â–¼               â–¼
Master    â”€â”€â†’  Slave1    â”€â”€â†’  Slave2

å½“ Master å®•æœºæ—¶ï¼ŒSentinel è‡ªåŠ¨é€‰ä¸¾æ–° Masterï¼š
                â–¼
         Slave1 å‡çº§ä¸º Master
```

**sentinel.conf é…ç½®**ï¼š
```ini
port 26379
sentinel monitor mymaster 192.168.1.100 6379 2  # 2ä¸ªå“¨å…µåŒæ„æ‰æ•…éšœè½¬ç§»
sentinel auth-pass mymaster yourpassword
sentinel down-after-milliseconds mymaster 30000  # 30ç§’æ— å“åº”è®¤ä¸ºå®•æœº
sentinel failover-timeout mymaster 180000
sentinel parallel-syncs mymaster 1              # æ•…éšœè½¬ç§»æ—¶åŒæ—¶åŒæ­¥çš„ä»èŠ‚ç‚¹æ•°
```

**å¯åŠ¨å“¨å…µ**ï¼š
```bash
redis-sentinel sentinel.conf
# æˆ–
redis-server sentinel.conf --sentinel
```

---

## 10. Redis é›†ç¾¤ï¼ˆClusterï¼‰

### 10.1 é›†ç¾¤æ¶æ„

Redis Cluster ä½¿ç”¨**æ•°æ®åˆ†ç‰‡**ï¼Œå°†æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ† **slotï¼ˆæ§½ï¼‰**ã€‚Redis å…±æœ‰ 16384 ä¸ª slotã€‚

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           Redis Cluster                 â”‚
        â”‚                                         â”‚
  slot  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚
0-5460  â”‚  â”‚ Master1  â”‚  â”‚ Master2  â”‚  â”‚Master3â”‚ â”‚
        â”‚  â”‚ (+ Slave)â”‚  â”‚ (+ Slave)â”‚  â”‚(+Slav)â”‚ â”‚
5461    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
-10922  â”‚                                         â”‚
10923   â”‚  key â†’ CRC16(key) % 16384 â†’ è·¯ç”±åˆ°å¯¹åº”èŠ‚ç‚¹ â”‚
-16383  â”‚                                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 é›†ç¾¤æ­å»º

```bash
# æœ€å°‘éœ€è¦3ä¸ªä¸»èŠ‚ç‚¹ï¼ˆæ¯ä¸ªä¸»èŠ‚ç‚¹ä¸€ä¸ªä»èŠ‚ç‚¹ = 6ä¸ªå®ä¾‹ï¼‰
# 6ä¸ªé…ç½®æ–‡ä»¶ï¼š7001.conf ~ 7006.conf

# åˆ›å»ºé›†ç¾¤
redis-cli --cluster create \
  127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 \
  127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006 \
  --cluster-replicas 1   # æ¯ä¸ªä¸»èŠ‚ç‚¹1ä¸ªä»èŠ‚ç‚¹

# è¿æ¥é›†ç¾¤ï¼ˆ-c å¯ç”¨é›†ç¾¤æ¨¡å¼ï¼Œè‡ªåŠ¨é‡å®šå‘ï¼‰
redis-cli -c -p 7001

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
redis-cli --cluster check 127.0.0.1:7001
CLUSTER INFO
CLUSTER NODES
```

### 10.3 Hash Tagsï¼ˆæ§½ä½å¯¹é½ï¼‰

é›†ç¾¤ä¸­ï¼Œå¤šä¸ª key åªæœ‰åœ¨åŒä¸€ä¸ª slot æ‰èƒ½ä½¿ç”¨ MGET ç­‰å¤š key æ“ä½œã€‚ä½¿ç”¨ `{}` æ¥æŒ‡å®š hash keyï¼š

```bash
# è¿™ä¸¤ä¸ª key ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ª slotï¼ˆæŒ‰ user:1001 è®¡ç®—ï¼‰
SET {user:1001}.name "Alice"
SET {user:1001}.age 25
MGET {user:1001}.name {user:1001}.age   # å¯ä»¥åœ¨åŒä¸€èŠ‚ç‚¹æ‰§è¡Œ
```

---

## 11. Redis + MySQL å®æˆ˜è®¾è®¡æ¨¡å¼

### 11.1 Cache-Asideï¼ˆæ—è·¯ç¼“å­˜ï¼Œæœ€å¸¸ç”¨ï¼‰

```
è¯»æ“ä½œï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                              â”‚
  â”‚  1. å…ˆæŸ¥ Redis                                â”‚
  â”‚     â”œâ”€ å‘½ä¸­ â†’ ç›´æ¥è¿”å›                        â”‚
  â”‚     â””â”€ æœªå‘½ä¸­ â†’ æŸ¥ MySQL â†’ å†™å…¥ Redis â†’ è¿”å›  â”‚
  â”‚                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†™æ“ä½œï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                              â”‚
  â”‚  1. å…ˆå†™ MySQL                                â”‚
  â”‚  2. å†åˆ é™¤ Redis ç¼“å­˜                         â”‚
  â”‚  ï¼ˆä¸æ˜¯æ›´æ–° Redisï¼é¿å…å¹¶å‘é—®é¢˜ï¼‰               â”‚
  â”‚                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆå†™æ“ä½œè¦åˆ ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ**
å› ä¸ºå¹¶å‘æ›´æ–°æ—¶ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å†™ MySQLï¼Œç„¶åå…ˆåæ›´æ–°ç¼“å­˜ï¼Œå¯èƒ½å¯¼è‡´æœ€ç»ˆç¼“å­˜çš„å€¼å’Œ MySQL ä¸ä¸€è‡´ã€‚åˆ é™¤ç¼“å­˜æ˜¯å¹‚ç­‰æ“ä½œï¼Œæ›´å®‰å…¨ã€‚

**å…ˆåˆ ç¼“å­˜è¿˜æ˜¯å…ˆåˆ æ•°æ®åº“ï¼Ÿ**
> åº”è¯¥**å…ˆå†™æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜**ï¼ˆCache-Aside æ¨¡å¼ï¼‰ã€‚
> å…ˆåˆ ç¼“å­˜ä¼šæœ‰çŸ­æš‚çš„è„è¯»çª—å£ï¼›å…ˆå†™æ•°æ®åº“å†åˆ ç¼“å­˜è™½ç„¶ä¹Ÿæœ‰æå°æ¦‚ç‡é—®é¢˜ï¼Œä½†å¯ç”¨å»¶è¿ŸåŒåˆ æˆ– Canal ç­‰æ–¹æ¡ˆè§£å†³ã€‚

---

### 11.2 ç¼“å­˜ç©¿é€ã€é›ªå´©ã€å‡»ç©¿

#### ç¼“å­˜ç©¿é€ï¼ˆæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼‰

```
å¤§é‡è¯·æ±‚æŸ¥è¯¢ id=-1ï¼ˆä¸å­˜åœ¨ï¼‰
    â”‚
    â†“ Redis æœªå‘½ä¸­
    â†“ MySQL ä¹Ÿæœªå‘½ä¸­
    â”‚
    â””â”€â”€å¤§é‡è¯·æ±‚æ‰“åˆ° MySQL â†’ DB å‹åŠ›æš´å¢
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **ç¼“å­˜ç©ºå€¼**ï¼šMySQL æœªå‘½ä¸­æ—¶ï¼Œå¾€ Redis å†™å…¥ä¸€ä¸ªçŸ­æœŸç©ºå€¼ï¼ˆå¦‚ 5åˆ†é’Ÿï¼‰
2. **å¸ƒéš†è¿‡æ»¤å™¨**ï¼šè¯·æ±‚è¿›æ¥å…ˆæŸ¥å¸ƒéš†è¿‡æ»¤å™¨ï¼Œä¸å­˜åœ¨çš„ key ç›´æ¥æ‹’ç»

```bash
# æ–¹æ¡ˆ1ï¼šç¼“å­˜ç©ºå€¼
SET user:99999 "" EX 300   # ç¼“å­˜ç©ºå€¼5åˆ†é’Ÿ
```

#### ç¼“å­˜é›ªå´©ï¼ˆå¤§é‡ key åŒæ—¶è¿‡æœŸï¼‰

```
å¤§é‡ key åœ¨åŒä¸€æ—¶åˆ»è¿‡æœŸ
    â”‚
    â†“ Redis æ‰¹é‡æœªå‘½ä¸­
    â””â”€â”€å¤§é‡è¯·æ±‚åŒæ—¶æ‰“åˆ° MySQL â†’ DB å´©æºƒ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ï¼š`TTL = base_ttl + random(0, 600)`
2. çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸï¼ˆæˆ–å¼‚æ­¥æ›´æ–°ï¼‰
3. Redis ä¸»ä» + å“¨å…µï¼Œä¿è¯ Redis é«˜å¯ç”¨

#### ç¼“å­˜å‡»ç©¿ï¼ˆçƒ­ç‚¹ key è¿‡æœŸç¬é—´ï¼‰

```
æŸä¸ªè¶…çƒ­ç‚¹ keyï¼ˆå¦‚ç§’æ€å•†å“ï¼‰çªç„¶è¿‡æœŸ
    â”‚
    â””â”€â”€å¤§é‡å¹¶å‘è¯·æ±‚åŒæ—¶ç©¿é€åˆ° MySQL
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **äº’æ–¥é”**ï¼šåªæœ‰ä¸€ä¸ªè¯·æ±‚å»æŸ¥ MySQLï¼Œå…¶ä»–è¯·æ±‚ç­‰å¾…ï¼ˆç”¨ Redis SET NX å®ç°åˆ†å¸ƒå¼é”ï¼‰
2. **é€»è¾‘è¿‡æœŸ**ï¼šä¸è®¾ç½®çœŸå®è¿‡æœŸæ—¶é—´ï¼Œè€Œæ˜¯åœ¨ value é‡Œè®°å½•è¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸåå¼‚æ­¥æ›´æ–°

```
// äº’æ–¥é”æ–¹æ¡ˆä¼ªä»£ç 
value = redis.get(key)
if value == null:
    if redis.set(lockKey, "1", NX, EX=5):  // è·å–é”
        value = mysql.query(key)
        redis.set(key, value, EX=3600)
        redis.del(lockKey)             // é‡Šæ”¾é”
    else:
        sleep(50ms)
        return getFromCache(key)       // é‡è¯•
```

---

### 11.3 åˆ†å¸ƒå¼é”

```bash
# åŠ é”ï¼šSET NX EX ä¿è¯åŸå­æ€§
SET lock:order_1001 "éšæœºå€¼UUID" NX EX 30

# è§£é”ï¼šç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§ï¼ˆå…ˆéªŒè¯å†åˆ é™¤ï¼‰
EVAL "
  if redis.call('get', KEYS[1]) == ARGV[1] then
    return redis.call('del', KEYS[1])
  else
    return 0
  end
" 1 lock:order_1001 "éšæœºå€¼UUID"
```

**æ³¨æ„äº‹é¡¹**ï¼š
- é”çš„ value å¿…é¡»æ˜¯éšæœºå”¯ä¸€å€¼ï¼ˆé˜²æ­¢è¯¯åˆ åˆ«äººçš„é”ï¼‰
- è¦è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆé˜²æ­¢æ­»é”ï¼‰
- ä¸šåŠ¡æ‰§è¡Œæ—¶é—´å¯èƒ½è¶…è¿‡é”è¿‡æœŸæ—¶é—´ï¼Œéœ€è¦**çœ‹é—¨ç‹—**æœºåˆ¶è‡ªåŠ¨ç»­æœŸï¼ˆRedisson å·²å®ç°ï¼‰

---

## 12. é«˜ QPS åœºæ™¯ä¸‹çš„ Redis å®è·µ

### 12.1 Pipelineï¼ˆç®¡é“ï¼‰

å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°ï¼Œå°†å¤šä¸ªå‘½ä»¤æ‰¹é‡å‘é€ï¼š

```
æ™®é€šæ¨¡å¼ï¼ˆNæ¬¡å¾€è¿”ï¼‰ï¼š
  Client â”€â”€CMD1â”€â”€â†’ Server
  Client â†â”€â”€RES1â”€â”€ Server
  Client â”€â”€CMD2â”€â”€â†’ Server
  Client â†â”€â”€RES2â”€â”€ Server

Pipeline æ¨¡å¼ï¼ˆ1æ¬¡å¾€è¿”ï¼‰ï¼š
  Client â”€â”€CMD1,CMD2,CMD3â”€â”€â†’ Server
  Client â†â”€â”€RES1,RES2,RES3â”€â”€ Server
```

**æ€§èƒ½å¯¹æ¯”**ï¼šæ‰§è¡Œ 10000 æ¬¡ SETï¼ŒPipeline æ¯”é€æ¡å‘é€å¿«çº¦ **10å€**ã€‚

### 12.2 è¿æ¥æ± 

æ¯æ¬¡æ“ä½œéƒ½å»ºç«‹æ–°è¿æ¥å¼€é”€å·¨å¤§ï¼Œå¿…é¡»ä½¿ç”¨è¿æ¥æ± ï¼š

```
åº”ç”¨ç¨‹åº
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    è¿æ¥æ±           â”‚
â”‚  conn1 (ç©ºé—²)     â”‚
â”‚  conn2 (ä½¿ç”¨ä¸­)   â”‚ â”€â”€â†’ Redis Server
â”‚  conn3 (ç©ºé—²)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.3 çƒ­ç‚¹ Key é—®é¢˜

å½“å•ä¸ª key çš„ QPS è¿œè¶…å…¶ä»– keyï¼ˆå¦‚æŸæ˜æ˜Ÿå¾®åšï¼‰ï¼Œå•èŠ‚ç‚¹å‹åŠ›è¿‡å¤§ï¼š

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **æœ¬åœ°ç¼“å­˜ï¼ˆå¤šçº§ç¼“å­˜ï¼‰**ï¼šåº”ç”¨å†…å­˜ â†’ Redis â†’ MySQL
2. **Key åˆ†ç‰‡**ï¼šå°† `hotkey` æ‹†åˆ†ä¸º `hotkey:0` ~ `hotkey:N`ï¼Œè¯·æ±‚éšæœºåˆ†é…

```
// çƒ­ç‚¹ key åˆ†ç‰‡
int shard = ThreadLocalRandom.nextInt(10);
String shardKey = "hotkey:" + shard;
String value = redis.get(shardKey);
if (value == null) {
    value = redis.get("hotkey");  // é™çº§æŸ¥åŸå§‹ key
}
```

### 12.4 å¤§ Key é—®é¢˜

å¤§ Key æ˜¯æŒ‡å•ä¸ª Key çš„ Value è¿‡å¤§ï¼ˆString > 10KBï¼‰ï¼Œæˆ–é›†åˆç±»å‹å…ƒç´ è¿‡å¤šï¼ˆ> 5000ï¼‰ã€‚

**å±å®³**ï¼š
- ç½‘ç»œä¼ è¾“æ…¢ï¼Œé˜»å¡å…¶ä»–è¯·æ±‚
- å†…å­˜ä¸å‡è¡¡ï¼ˆé›†ç¾¤ä¸­æŸä¸ªèŠ‚ç‚¹å†…å­˜è¿œå¤§äºå…¶ä»–èŠ‚ç‚¹ï¼‰
- åˆ é™¤å¤§ Key ä¼šé˜»å¡ Redisï¼ˆDEL æ˜¯åŒæ­¥çš„ï¼ï¼‰

**æ£€æŸ¥å¤§ Key**ï¼š
```bash
redis-cli --bigkeys    # æ‰«æå¤§ key
redis-cli --memkeys    # æŒ‰å†…å­˜å¤§å°æ’åº
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ‹†åˆ†å¤§ Keyï¼ˆå¦‚å°†ä¸€ä¸ªå¤§ Hash æ‹†æˆå¤šä¸ªå° Hashï¼‰
- å‹ç¼© Valueï¼ˆä½¿ç”¨ gzip ç­‰ï¼‰
- å¼‚æ­¥åˆ é™¤å¤§ Keyï¼š`UNLINK key`ï¼ˆéé˜»å¡ï¼Œåå°åˆ é™¤ï¼‰

---

## 13. C++ å®¢æˆ·ç«¯ä½¿ç”¨ï¼ˆhiredisï¼‰

### 13.1 å®‰è£… hiredis

```bash
# Ubuntu
sudo apt install libhiredis-dev

# ä»æºç å®‰è£…
git clone https://github.com/redis/hiredis.git
cd hiredis
make && sudo make install
```

### 13.2 åŸºç¡€ä½¿ç”¨

```cpp
#include <hiredis/hiredis.h>
#include <iostream>
#include <string>

int main() {
    // å»ºç«‹è¿æ¥
    redisContext* context = redisConnect("127.0.0.1", 6379);
    if (context == nullptr || context->err) {
        if (context) {
            std::cerr << "Connection error: " << context->errstr << std::endl;
            redisFree(context);
        } else {
            std::cerr << "Can't allocate redis context" << std::endl;
        }
        return 1;
    }

    // å¯†ç è®¤è¯
    redisReply* reply = (redisReply*)redisCommand(context, "AUTH %s", "yourpassword");
    freeReplyObject(reply);

    // SET å‘½ä»¤
    reply = (redisReply*)redisCommand(context, "SET %s %s", "mykey", "hello redis");
    std::cout << "SET: " << reply->str << std::endl;
    freeReplyObject(reply);

    // GET å‘½ä»¤
    reply = (redisReply*)redisCommand(context, "GET %s", "mykey");
    if (reply->type == REDIS_REPLY_STRING) {
        std::cout << "GET: " << reply->str << std::endl;
    } else if (reply->type == REDIS_REPLY_NIL) {
        std::cout << "Key not found" << std::endl;
    }
    freeReplyObject(reply);

    // HSET / HGETALL
    reply = (redisReply*)redisCommand(context, "HSET user:1 name Alice age 25");
    freeReplyObject(reply);

    reply = (redisReply*)redisCommand(context, "HGETALL user:1");
    if (reply->type == REDIS_REPLY_ARRAY) {
        for (size_t i = 0; i < reply->elements; i += 2) {
            std::cout << reply->element[i]->str << ": " 
                      << reply->element[i+1]->str << std::endl;
        }
    }
    freeReplyObject(reply);

    // æ–­å¼€è¿æ¥
    redisFree(context);
    return 0;
}
```

```bash
# ç¼–è¯‘
g++ -o redis_demo redis_demo.cpp -lhiredis
```

### 13.3 Pipeline ä½¿ç”¨

```cpp
// æ‰¹é‡å‘é€å‘½ä»¤ï¼Œä¸ç­‰å¾…å“åº”
redisAppendCommand(context, "SET k1 v1");
redisAppendCommand(context, "SET k2 v2");
redisAppendCommand(context, "GET k1");

// æ‰¹é‡æ¥æ”¶å“åº”
redisReply* reply;
for (int i = 0; i < 3; i++) {
    redisGetReply(context, (void**)&reply);
    // å¤„ç†æ¯ä¸ªå“åº”
    freeReplyObject(reply);
}
```

### 13.4 æ›´ç°ä»£çš„ C++ å®¢æˆ·ç«¯ï¼šredis-plus-plus

```cpp
// åŸºäº hiredis å°è£…ï¼Œæ”¯æŒ C++17ï¼ŒAPI æ›´å‹å¥½
#include <sw/redis++/redis++.h>

using namespace sw::redis;

// å•æœº
Redis redis("tcp://127.0.0.1:6379");
// å¸¦å¯†ç 
Redis redis("tcp://:password@127.0.0.1:6379");
// è¿æ¥æ± 
ConnectionOptions opts;
opts.host = "127.0.0.1";
opts.port = 6379;
opts.password = "yourpassword";
ConnectionPoolOptions pool_opts;
pool_opts.size = 10;   // è¿æ¥æ± å¤§å°
Redis redis(opts, pool_opts);

// åŸºæœ¬æ“ä½œ
redis.set("key", "value");
auto val = redis.get("key");  // OptionalString
if (val) std::cout << *val << std::endl;

// Hash
redis.hset("user:1", "name", "Alice");
auto name = redis.hget("user:1", "name");

// Pipeline
auto pipe = redis.pipeline();
pipe.set("k1", "v1").set("k2", "v2").get("k1");
auto replies = pipe.exec();

// ç¼–è¯‘ï¼šg++ -o demo demo.cpp -lhiredis -lredis++ -std=c++17
```

---

## 14. Redis å®‰å…¨ä¸è¿ç»´

### 14.1 å®‰å…¨é…ç½®

```ini
# 1. è®¾ç½®å¯†ç ï¼ˆå¿…é¡»ï¼ï¼‰
requirepass StrongPassword123!

# 2. é‡å‘½åå±é™©å‘½ä»¤ï¼ˆæˆ–ç¦ç”¨ï¼‰
rename-command FLUSHALL ""      # ç¦ç”¨ FLUSHALL
rename-command CONFIG "CONFIG_9a3b"  # é‡å‘½å CONFIG

# 3. ç»‘å®šç‰¹å®š IP
bind 127.0.0.1 192.168.1.100

# 4. ç¦æ­¢å¤–ç½‘ç›´æ¥è®¿é—®
protected-mode yes

# 5. ä½¿ç”¨ TLSï¼ˆRedis 6.0+ï¼‰
tls-port 6380
tls-cert-file /path/to/redis.crt
tls-key-file /path/to/redis.key
```

### 14.2 ç›‘æ§æŒ‡æ ‡

```bash
# å…³é”®ç›‘æ§å‘½ä»¤
INFO all                    # å…¨éƒ¨ä¿¡æ¯
INFO memory                 # å†…å­˜ä½¿ç”¨
INFO stats                  # å‘½ä¸­ç‡ç­‰ç»Ÿè®¡
INFO replication            # ä¸»ä»çŠ¶æ€
INFO clients                # å®¢æˆ·ç«¯è¿æ¥æ•°

# å…³é”®æŒ‡æ ‡
used_memory_human            # å·²ç”¨å†…å­˜
mem_fragmentation_ratio      # å†…å­˜ç¢ç‰‡ç‡ï¼ˆ>1.5 éœ€å…³æ³¨ï¼‰
keyspace_hits/misses         # ç¼“å­˜å‘½ä¸­ç‡ = hits/(hits+misses)
instantaneous_ops_per_sec    # å½“å‰ QPS
connected_clients            # å½“å‰è¿æ¥æ•°
rejected_connections         # è¢«æ‹’ç»çš„è¿æ¥æ•°
```

### 14.3 æ€§èƒ½æ’æŸ¥

```bash
# 1. æŸ¥çœ‹æ…¢æŸ¥è¯¢
SLOWLOG GET 10              # æœ€è¿‘10æ¡æ…¢æŸ¥è¯¢
SLOWLOG LEN                 # æ…¢æŸ¥è¯¢æ¡æ•°
SLOWLOG RESET               # æ¸…ç©ºæ…¢æŸ¥è¯¢æ—¥å¿—

# 2. å®æ—¶ç›‘æ§ï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼Œç”Ÿäº§æ…ç”¨ï¼‰
MONITOR

# 3. åˆ†æ CPU ç“¶é¢ˆï¼ˆä½¿ç”¨ redis-cli --statï¼‰
redis-cli --stat

# 4. å†…å­˜åˆ†æ
redis-cli --memkeys          # æ‰¾å¤§ key
redis-cli --bigkeys

# 5. æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
redis-cli --latency
redis-cli --latency-history

# 6. çƒ­ç‚¹ key åˆ†æï¼ˆRedis 4.0+ï¼‰
redis-cli --hotkeys
```

---

## 15. Redis é¢è¯•é¢˜ç²¾é€‰

### ğŸ“Œ åŸºç¡€ç¯‡

---

**Q1ï¼šRedis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ**

> Redis ä¹‹æ‰€ä»¥é«˜æ€§èƒ½ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š
> 1. **çº¯å†…å­˜æ“ä½œ**ï¼šæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™é€Ÿåº¦æ˜¯ç£ç›˜çš„å‡ ä¸ªæ•°é‡çº§ä»¥ä¸Š
> 2. **å•çº¿ç¨‹å‘½ä»¤æ‰§è¡Œ**ï¼šé¿å…äº†å¤šçº¿ç¨‹å¸¦æ¥çš„é”ç«äº‰å’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼ˆRedis 6.0 å IO å¤šçº¿ç¨‹ï¼Œä½†å‘½ä»¤æ‰§è¡Œä»æ˜¯å•çº¿ç¨‹ï¼‰
> 3. **IO å¤šè·¯å¤ç”¨**ï¼šä½¿ç”¨ epoll ç­‰æœºåˆ¶ï¼Œå•çº¿ç¨‹å°±èƒ½å¤„ç†å¤§é‡å¹¶å‘è¿æ¥
> 4. **é«˜æ•ˆçš„æ•°æ®ç»“æ„**ï¼šåº•å±‚ä½¿ç”¨è·³è¡¨ã€å‹ç¼©åˆ—è¡¨ã€å“ˆå¸Œè¡¨ç­‰ç²¾å¿ƒè®¾è®¡çš„æ•°æ®ç»“æ„
> 5. **RESP åè®®ç®€å•**ï¼šé€šä¿¡åè®®è½»é‡ï¼Œè§£æå¼€é”€æä½

---

**Q2ï¼šRedis çš„æ•°æ®ç±»å‹æœ‰å“ªäº›ï¼Ÿå„é€‚ç”¨ä»€ä¹ˆåœºæ™¯ï¼Ÿ**

> - **String**ï¼šç¼“å­˜ã€è®¡æ•°å™¨ã€åˆ†å¸ƒå¼é”ã€Session
> - **Hash**ï¼šå­˜å‚¨å¯¹è±¡ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰ï¼Œå¯å•ç‹¬è¯»å†™å­—æ®µ
> - **List**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€æœ€æ–°åŠ¨æ€ã€æ“ä½œå†å²
> - **Set**ï¼šæ ‡ç­¾ã€å¥½å‹å…³ç³»ã€å»é‡ç»Ÿè®¡ã€æŠ½å¥–
> - **ZSet**ï¼šæ’è¡Œæ¦œã€å»¶è¿Ÿé˜Ÿåˆ—ã€æ»‘åŠ¨çª—å£é™æµ
> - **Bitmap**ï¼šç­¾åˆ°ã€åœ¨çº¿çŠ¶æ€ç»Ÿè®¡ï¼ˆæµ·é‡ç”¨æˆ·ï¼‰
> - **HyperLogLog**ï¼šUV ç»Ÿè®¡ï¼ˆä¸éœ€è¦ç²¾ç¡®å€¼ï¼‰
> - **Geo**ï¼šé™„è¿‘çš„äºº/å•†å®¶

---

**Q3ï¼šRedis æŒä¹…åŒ– RDB å’Œ AOF çš„åŒºåˆ«ï¼Ÿ**

> | | RDB | AOF |
> |--|--|--|
> | åŸç† | å†…å­˜å¿«ç…§ | å†™å‘½ä»¤è¿½åŠ æ—¥å¿— |
> | æ•°æ®å®Œæ•´æ€§ | ä½ï¼ˆå¯èƒ½ä¸¢å¤±å‡ åˆ†é’Ÿæ•°æ®ï¼‰ | é«˜ï¼ˆæœ€å¤šä¸¢1ç§’ï¼Œeverysecï¼‰ |
> | æ¢å¤é€Ÿåº¦ | å¿« | æ…¢ |
> | æ–‡ä»¶å¤§å° | å° | å¤§ |
> | é€‚åˆåœºæ™¯ | å¤‡ä»½ï¼Œå¯æ¥å—å°‘é‡ä¸¢å¤± | å¯¹æ•°æ®å®Œæ•´æ€§è¦æ±‚é«˜ |
>
> **ç”Ÿäº§å»ºè®®**ï¼šä¸¤è€…åŒæ—¶å¼€å¯ã€‚ä¼˜å…ˆç”¨ AOF æ¢å¤ï¼ŒåŒæ—¶ç”¨ RDB åšå®šæœŸå¤‡ä»½ã€‚

---

**Q4ï¼šRedis æ˜¯å•çº¿ç¨‹çš„ï¼Œä¸ºä»€ä¹ˆè¿˜è¿™ä¹ˆé«˜æ•ˆï¼Ÿå•çº¿ç¨‹ä¸æ˜¯ç“¶é¢ˆå—ï¼Ÿ**

> Redis çš„å•çº¿ç¨‹æ˜¯æŒ‡**å‘½ä»¤æ‰§è¡Œæ˜¯å•çº¿ç¨‹**çš„ï¼ŒIO æ“ä½œé€šè¿‡ epoll å¤šè·¯å¤ç”¨å¤„ç†ã€‚
>
> ä¸æ˜¯ç“¶é¢ˆçš„åŸå› ï¼šRedis æ“ä½œçš„è€—æ—¶æçŸ­ï¼ˆå¾®ç§’çº§ï¼‰ï¼ŒCPU ä¸æ˜¯ç“¶é¢ˆï¼Œç“¶é¢ˆé€šå¸¸åœ¨ç½‘ç»œ IO å’Œå†…å­˜å¸¦å®½ã€‚
>
> Redis 6.0 ä¹‹åå¼•å…¥äº†**å¤šçº¿ç¨‹ IO**ï¼Œç”¨å¤šçº¿ç¨‹å¤„ç†ç½‘ç»œæ•°æ®è¯»å†™ï¼ˆparse/serializeï¼‰ï¼Œä½†å‘½ä»¤æ‰§è¡Œä»æ˜¯å•çº¿ç¨‹ï¼Œè¿›ä¸€æ­¥æå‡äº†é«˜å¹¶å‘ä¸‹çš„ååé‡ã€‚

---

### ğŸ“Œ åŸç†ç¯‡

---

**Q5ï¼šè·³è¡¨æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆ ZSet ä½¿ç”¨è·³è¡¨è€Œä¸æ˜¯çº¢é»‘æ ‘ï¼Ÿ**

> è·³è¡¨æ˜¯ä¸€ç§å¤šå±‚çš„æœ‰åºé“¾è¡¨ï¼Œé€šè¿‡åœ¨é“¾è¡¨ä¸Šå»ºç«‹å¤šå±‚ç´¢å¼•ï¼Œå®ç° O(log N) çš„æŸ¥æ‰¾æ•ˆç‡ã€‚
>
> é€‰æ‹©è·³è¡¨è€Œéçº¢é»‘æ ‘çš„åŸå› ï¼š
> 1. **èŒƒå›´æŸ¥è¯¢**ï¼šè·³è¡¨æ”¯æŒé«˜æ•ˆçš„èŒƒå›´æŸ¥è¯¢ï¼ˆZRANGEBYSCOREï¼‰ï¼Œè€Œçº¢é»‘æ ‘å®ç°èŒƒå›´æŸ¥è¯¢éœ€è¦ä¸­åºéå†
> 2. **å®ç°ç®€å•**ï¼šè·³è¡¨æ¯”çº¢é»‘æ ‘ä»£ç ç®€æ´ï¼Œæ›´å®¹æ˜“ç»´æŠ¤
> 3. **å†…å­˜æ•ˆç‡**ï¼šRedis çš„è·³è¡¨å®ç°åšäº†å†…å­˜ä¼˜åŒ–

---

**Q6ï¼šRedis çš„å†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿç”Ÿäº§ä¸­å¦‚ä½•é€‰æ‹©ï¼Ÿ**

> Redis æœ‰ 8 ç§æ·˜æ±°ç­–ç•¥ï¼šnoevictionã€allkeys-lruã€allkeys-lfuã€allkeys-randomã€volatile-lruã€volatile-lfuã€volatile-randomã€volatile-ttlã€‚
>
> ç”Ÿäº§é€‰æ‹©å»ºè®®ï¼š
> - **é€šç”¨ç¼“å­˜**ï¼š`allkeys-lru`ï¼ˆæœ€æ¨èï¼‰
> - **éƒ¨åˆ†æ•°æ®ä¸èƒ½è¢«æ·˜æ±°**ï¼š`volatile-lru`ï¼ˆåªæ·˜æ±°è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ï¼‰
> - **è®¿é—®æ¨¡å¼å·®å¼‚å¤§**ï¼š`allkeys-lfu`ï¼ˆLFU æ›´èƒ½ä¿ç•™çœŸæ­£çƒ­ç‚¹æ•°æ®ï¼‰
> - **ä¸¥ç¦ä¸¢å¤±æ•°æ®**ï¼š`noeviction`ï¼ŒåŒæ—¶é…åˆå……è¶³å†…å­˜

---

**Q7ï¼šç¼“å­˜ç©¿é€ã€é›ªå´©ã€å‡»ç©¿åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ**

> **ç¼“å­˜ç©¿é€**ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„ keyï¼Œæ¯æ¬¡éƒ½ç©¿é€åˆ° DB
> - è§£å†³ï¼šç¼“å­˜ç©ºå€¼ + å¸ƒéš†è¿‡æ»¤å™¨å‰ç½®æ‹¦æˆª
>
> **ç¼“å­˜é›ªå´©**ï¼šå¤§é‡ key åŒæ—¶è¿‡æœŸï¼Œæˆ– Redis å®•æœºï¼Œå¤§é‡è¯·æ±‚æ¶Œå…¥ DB
> - è§£å†³ï¼šè¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ï¼›Redis é«˜å¯ç”¨ï¼ˆä¸»ä»+å“¨å…µï¼‰ï¼›é™æµé™çº§
>
> **ç¼“å­˜å‡»ç©¿**ï¼šå•ä¸ªçƒ­ç‚¹ key çªç„¶è¿‡æœŸï¼Œå¤§é‡å¹¶å‘è¯·æ±‚æ‰“åˆ° DB
> - è§£å†³ï¼šäº’æ–¥é”ï¼ˆåªè®©ä¸€ä¸ªè¯·æ±‚æŸ¥ DBï¼‰ï¼›é€»è¾‘è¿‡æœŸï¼ˆä¸è®¾çœŸå®è¿‡æœŸï¼Œå¼‚æ­¥æ›´æ–°ï¼‰

---

**Q8ï¼šRedis äº‹åŠ¡æ˜¯å¦æ”¯æŒåŸå­æ€§ï¼Ÿä¸ Lua è„šæœ¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

> Redis äº‹åŠ¡ï¼ˆMULTI/EXECï¼‰**ä¸å®Œå…¨æ”¯æŒåŸå­æ€§**ï¼š
> - å‘½ä»¤è¯­æ³•é”™è¯¯ï¼šEXEC æ—¶æ‰€æœ‰å‘½ä»¤éƒ½ä¸æ‰§è¡Œï¼ˆæœ‰åŸå­æ€§ï¼‰
> - è¿è¡Œæ—¶é”™è¯¯ï¼šå…¶ä»–å‘½ä»¤ç»§ç»­æ‰§è¡Œï¼ˆæ²¡æœ‰åŸå­æ€§ï¼Œä¸ä¼šå›æ»šï¼‰
>
> **Lua è„šæœ¬æ‰æ˜¯çœŸæ­£åŸå­çš„**ï¼šæ‰§è¡Œ Lua è„šæœ¬æœŸé—´ï¼ŒRedis ä¸ä¼šæ‰§è¡Œå…¶ä»–å‘½ä»¤ï¼Œä¿è¯äº†åŸå­æ€§ã€‚å› æ­¤éœ€è¦åŸå­åŒ–æ“ä½œï¼ˆå¦‚åˆ†å¸ƒå¼é”çš„æ£€æŸ¥+åˆ é™¤ï¼‰ï¼Œåº”è¯¥ä½¿ç”¨ Lua è„šæœ¬è€Œä¸æ˜¯äº‹åŠ¡ã€‚

---

**Q9ï¼šå¦‚ä½•å®ç° Redis åˆ†å¸ƒå¼é”ï¼Ÿæœ‰ä»€ä¹ˆå‘ï¼Ÿ**

> **åŸºæœ¬å®ç°**ï¼š
> ```
> åŠ é”ï¼šSET lock_key random_uuid NX EX 30
> è§£é”ï¼šLuaè„šæœ¬ åˆ¤æ–­value==uuidåˆ™DEL
> ```
>
> **å¸¸è§å‘**ï¼š
> 1. **è¯¯åˆ ä»–äººé”**ï¼šè§£é”æ—¶å¿…é¡»éªŒè¯ value æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼ˆç”¨éšæœº UUIDï¼‰
> 2. **é”è¶…æ—¶**ï¼šä¸šåŠ¡æ‰§è¡Œè¶…è¿‡é”è¿‡æœŸæ—¶é—´ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼Œéœ€è¦ç»­æœŸï¼ˆçœ‹é—¨ç‹—æœºåˆ¶ï¼‰
> 3. **Redis ä¸»ä»æ¶æ„**ï¼šä¸»èŠ‚ç‚¹å†™é”åæœªåŒæ­¥å°±å®•æœºï¼Œä»èŠ‚ç‚¹å‡ä¸ºä¸»åé”ä¸¢å¤±ï¼ˆRedlock ç®—æ³•è§£å†³ï¼Œä½†æœ‰äº‰è®®ï¼‰
> 4. **è§£é”éåŸå­**ï¼šGET å’Œ DEL å¿…é¡»ç”¨ Lua ä¿è¯åŸå­æ€§

---

### ğŸ“Œ é«˜çº§ç¯‡

---

**Q10ï¼šRedis ä¸»ä»å¤åˆ¶çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ**

> 1. ä»èŠ‚ç‚¹å‘é€ `PSYNC` å‘½ä»¤ï¼ˆæºå¸¦ runId å’Œ offsetï¼‰
> 2. å¦‚æœæ˜¯é¦–æ¬¡åŒæ­¥ï¼ˆæˆ– runId ä¸åŒ¹é…ï¼‰ï¼Œä¸»èŠ‚ç‚¹æ‰§è¡Œ BGSAVE ç”Ÿæˆ RDBï¼ŒåŒæ—¶ç”¨ repl_backlog_buffer ç¼“å†²æ–°å†™å‘½ä»¤
> 3. ä¸»èŠ‚ç‚¹å°† RDB å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹åŠ è½½ RDB
> 4. ä¸»èŠ‚ç‚¹å‘é€ repl_backlog_buffer ä¸­çš„å‘½ä»¤ï¼Œä»èŠ‚ç‚¹æ‰§è¡Œï¼Œå®Œæˆå…¨é‡åŒæ­¥
> 5. ä¹‹åè¿›å…¥**å¢é‡åŒæ­¥**ï¼šä¸»èŠ‚ç‚¹æ¯æ‰§è¡Œä¸€æ¡å†™å‘½ä»¤ï¼Œå¼‚æ­¥å‘ç»™ä»èŠ‚ç‚¹
> 6. ç½‘ç»œæ–­å¼€é‡è¿åï¼Œå°è¯•**æ–­ç‚¹ç»­ä¼ **ï¼ˆç”¨ offset ä» backlog ä¸­è¡¥å‘ï¼‰

---

**Q11ï¼šå“¨å…µæ¨¡å¼å¦‚ä½•å®ç°æ•…éšœè½¬ç§»ï¼Ÿ**

> 1. **ä¸»è§‚ä¸‹çº¿ï¼ˆSDOWNï¼‰**ï¼šå•ä¸ªå“¨å…µè¶…è¿‡ `down-after-milliseconds` æ”¶ä¸åˆ°ä¸»èŠ‚ç‚¹å“åº”ï¼Œæ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿
> 2. **å®¢è§‚ä¸‹çº¿ï¼ˆODOWNï¼‰**ï¼šè¾¾åˆ°æ³•å®šæ•°é‡çš„å“¨å…µï¼ˆquorumï¼‰éƒ½è®¤ä¸ºä¸»èŠ‚ç‚¹ä¸‹çº¿ï¼Œæ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿
> 3. **é€‰ä¸¾ Leader å“¨å…µ**ï¼šå“¨å…µä¹‹é—´é€šè¿‡ Raft é€‰ä¸¾ä¸€ä¸ª Leader æ¥æ‰§è¡Œæ•…éšœè½¬ç§»
> 4. **é€‰æ–°ä¸»èŠ‚ç‚¹**ï¼šLeader ä»ä»èŠ‚ç‚¹ä¸­é€‰ä¼˜å…ˆçº§é«˜ã€å¤åˆ¶åç§»é‡æœ€å¤§çš„ä½œä¸ºæ–°ä¸»èŠ‚ç‚¹
> 5. **æ•…éšœè½¬ç§»**ï¼šè®©æ–°ä¸»èŠ‚ç‚¹æ‰§è¡Œ `REPLICAOF NO ONE`ï¼Œå…¶ä»–ä»èŠ‚ç‚¹ `REPLICAOF æ–°ä¸»èŠ‚ç‚¹`
> 6. **é€šçŸ¥å®¢æˆ·ç«¯**ï¼šå“¨å…µé€šè¿‡ Pub/Sub é€šçŸ¥å®¢æˆ·ç«¯æ–°çš„ä¸»èŠ‚ç‚¹åœ°å€

---

**Q12ï¼šRedis Cluster çš„æ•°æ®åˆ†ç‰‡åŸç†ï¼Ÿå®¢æˆ·ç«¯å¦‚ä½•è·¯ç”±ï¼Ÿ**

> Redis Cluster å°†æ‰€æœ‰æ•°æ®åˆ†ä¸º **16384 ä¸ª slotï¼ˆæ§½ï¼‰**ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£éƒ¨åˆ† slotã€‚
>
> **è·¯ç”±è®¡ç®—**ï¼š`CRC16(key) % 16384` å¾—åˆ° slot ç¼–å·ï¼Œå®¢æˆ·ç«¯æ ¹æ® slot æ‰¾åˆ°å¯¹åº”èŠ‚ç‚¹ã€‚
>
> **MOVED é‡å®šå‘**ï¼šè‹¥è¯·æ±‚å‘åˆ°äº†é”™è¯¯èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹è¿”å› `MOVED slot æ­£ç¡®èŠ‚ç‚¹IP:Port`ï¼Œå®¢æˆ·ç«¯é‡æ–°è¯·æ±‚æ­£ç¡®èŠ‚ç‚¹ï¼Œå¹¶æ›´æ–°æœ¬åœ°è·¯ç”±è¡¨ã€‚
>
> **ASK é‡å®šå‘**ï¼šåœ¨æ•°æ®è¿ç§»è¿‡ç¨‹ä¸­ï¼Œslot çš„æ•°æ®æ­£åœ¨ä» A èŠ‚ç‚¹è¿å¾€ B èŠ‚ç‚¹ï¼Œè‹¥ A ä¸­æ‰¾ä¸åˆ°è¯¥ keyï¼Œè¿”å› `ASK` è®©å®¢æˆ·ç«¯å» B æŸ¥ï¼Œä½†ä¸æ›´æ–°è·¯ç”±è¡¨ï¼ˆæ˜¯ä¸´æ—¶çš„ï¼‰ã€‚

---

**Q13ï¼šRedis å¤§ Key æœ‰ä»€ä¹ˆå±å®³ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ**

> **å±å®³**ï¼š
> - å•æ¬¡è¯»å†™å ç”¨å¤§é‡ç½‘ç»œå¸¦å®½ï¼Œå½±å“å…¶ä»–è¯·æ±‚
> - DEL å¤§ Key ä¼šé˜»å¡ Redisï¼ˆå‡ åæ¯«ç§’ç”šè‡³æ›´é•¿ï¼‰
> - é›†ç¾¤æ¨¡å¼ä¸‹å¯¼è‡´èŠ‚ç‚¹å†…å­˜ä¸å‡è¡¡
> - åºåˆ—åŒ–/ååºåˆ—åŒ–è€—æ—¶é•¿
>
> **è§£å†³**ï¼š
> - æ‹†åˆ†ï¼šå¤§ Hash æŒ‰ field æ‹†åˆ†æˆå¤šä¸ªå° Hash
> - å‹ç¼©ï¼šValue ä½¿ç”¨å‹ç¼©ï¼ˆgzip/snappyï¼‰
> - å¼‚æ­¥åˆ é™¤ï¼šä½¿ç”¨ `UNLINK` æ›¿ä»£ `DEL`ï¼ˆéé˜»å¡åå°åˆ é™¤ï¼‰
> - æ‡’åˆ é™¤é…ç½®ï¼š`lazyfree-lazy-expire yes`

---

**Q14ï¼šå¦‚ä½•ä¿è¯ Redis å’Œ MySQL çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ**

> è¿™æ˜¯é«˜é¢‘è€ƒé¢˜ï¼Œæ ¸å¿ƒæ€è·¯æ˜¯**æœ€ç»ˆä¸€è‡´æ€§**ï¼Œå®Œå…¨å¼ºä¸€è‡´æˆæœ¬å¾ˆé«˜ã€‚
>
> **å¸¸è§æ–¹æ¡ˆ**ï¼š
>
> 1. **Cache-Aside + å…ˆå†™DBååˆ ç¼“å­˜**ï¼šä¸»æµæ–¹æ¡ˆï¼Œå­˜åœ¨æçŸ­æš‚ä¸ä¸€è‡´çª—å£
>
> 2. **å»¶è¿ŸåŒåˆ **ï¼šå†™ DB åå…ˆåˆ ç¼“å­˜ï¼Œç­‰ 500ms åå†åˆ ä¸€æ¬¡ï¼ˆåº”å¯¹ä¸»ä»å»¶è¿Ÿï¼‰
>
> 3. **æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ›´æ–°**ï¼šå†™ DB æˆåŠŸåå‘æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ›´æ–°/åˆ é™¤ç¼“å­˜ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´
>
> 4. **Canal ç›‘å¬ binlog**ï¼šé˜¿é‡Œå¼€æºçš„ MySQL binlog ç›‘å¬å·¥å…·ï¼Œæ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°ç¼“å­˜ï¼Œä¸šåŠ¡ä»£ç æ— ä¾µå…¥
>
> **å»¶ä¼¸**ï¼šåœ¨å®é™…å·¥ç¨‹ä¸­ï¼Œé€šå¸¸å®¹å¿çŸ­æš‚ä¸ä¸€è‡´ï¼ˆç§’çº§ï¼‰ï¼Œé€šè¿‡è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´å…œåº•ã€‚

---

**Q15ï¼šRedis çš„ Key è¿‡æœŸäº†ä¸€å®šä¼šç«‹å³åˆ é™¤å—ï¼Ÿ**

> **ä¸ä¼šç«‹å³åˆ é™¤ï¼** Redis é‡‡ç”¨ä¸¤ç§ç­–ç•¥ç»“åˆï¼š
>
> - **æƒ°æ€§åˆ é™¤**ï¼šè®¿é—® key æ—¶æ‰æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸåˆ™åˆ é™¤ã€‚ä¼˜ç‚¹æ˜¯ CPU å‹å¥½ï¼Œç¼ºç‚¹æ˜¯è¿‡æœŸ key å¯èƒ½é•¿æœŸé©»ç•™å†…å­˜ã€‚
> - **å®šæœŸåˆ é™¤**ï¼šæ¯éš” 100ms éšæœºæŠ½æŸ¥ä¸€æ‰¹ keyï¼Œåˆ é™¤å…¶ä¸­è¿‡æœŸçš„ã€‚å¦‚æœè¿‡æœŸç‡è¶…è¿‡ 25%ï¼Œç»§ç»­æŠ½æŸ¥ã€‚
>
> **å½±å“**ï¼šè¿‡æœŸ key ä¸ä¼šç«‹å³é‡Šæ”¾å†…å­˜ï¼Œåœ¨é«˜å†…å­˜å‹åŠ›ä¸‹è¿˜ä¼šè§¦å‘å†…å­˜æ·˜æ±°ç­–ç•¥ã€‚åœ¨ä¸šåŠ¡å±‚é¢ï¼Œè¿‡æœŸ key åœ¨æƒ°æ€§åˆ é™¤å‰ä¸ä¼šè¢« GET åˆ°ï¼ˆä¼šè¿”å› nilï¼‰ï¼Œä½†å®ƒåœ¨å†…å­˜ä¸­ç¡®å®è¿˜å­˜åœ¨ã€‚

---

**Q16ï¼šRedis 6.0 ä¸ºä»€ä¹ˆå¼•å…¥å¤šçº¿ç¨‹ï¼Ÿå¤šçº¿ç¨‹æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ**

> Redis 6.0 å¼•å…¥å¤šçº¿ç¨‹æ˜¯ä¸ºäº†è§£å†³**ç½‘ç»œ IO ç“¶é¢ˆ**ï¼Œä¸æ˜¯ä¸ºäº†å‘½ä»¤æ‰§è¡Œå¹¶è¡ŒåŒ–ã€‚
>
> **å·¥ä½œæ–¹å¼**ï¼š
> 1. ä¸»çº¿ç¨‹æ¥å—æ–°è¿æ¥
> 2. å¤šä¸ª IO çº¿ç¨‹å¹¶è¡Œè¯»å–å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®ï¼ˆparseï¼‰
> 3. **ä¸»çº¿ç¨‹å•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œæ‰€æœ‰å‘½ä»¤**ï¼ˆä¿è¯çº¿ç¨‹å®‰å…¨ï¼‰
> 4. å¤šä¸ª IO çº¿ç¨‹å¹¶è¡Œå†™å›å“åº”æ•°æ®ï¼ˆserializeï¼‰
>
> æ ¸å¿ƒè®¾è®¡ï¼šå‘½ä»¤æ‰§è¡Œä»æ˜¯å•çº¿ç¨‹ï¼Œåªæœ‰ç½‘ç»œ IO æ˜¯å¤šçº¿ç¨‹ã€‚è¿™æ ·æ—¢æå‡äº†é«˜å¹¶å‘ä¸‹çš„ååé‡ï¼Œåˆä¿æŒäº†æ•°æ®æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚

---

**Q17ï¼šä»€ä¹ˆæ˜¯ Redis çš„ rehashï¼Ÿå¦‚ä½•é¿å… rehash é˜»å¡ï¼Ÿ**

> Redis çš„ Hash åº•å±‚ä½¿ç”¨ä¸¤ä¸ª hashtableï¼ˆht[0] å’Œ ht[1]ï¼‰ã€‚å½“è´Ÿè½½å› å­è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘ rehashï¼š
>
> 1. ä¸º ht[1] åˆ†é…æ›´å¤§çš„ç©ºé—´
> 2. **æ¸è¿›å¼ rehash**ï¼šæ¯æ¬¡å¯¹ ht[0] è¿›è¡Œå¢åˆ æŸ¥æ”¹æ—¶ï¼Œé¡ºå¸¦å°† ht[0] ä¸Šçš„è‹¥å¹²ä¸ªæ¡¶ï¼ˆbucketï¼‰è¿ç§»åˆ° ht[1]
> 3. è¿ç§»å®Œæˆåï¼Œé‡Šæ”¾ ht[0]ï¼Œht[1] å˜ä¸º ht[0]
>
> **æ¸è¿›å¼ rehash** æ˜¯å…³é”®ï¼šä¸æ˜¯ä¸€æ¬¡æ€§å…¨éƒ¨è¿ç§»ï¼ˆä¼šé˜»å¡ï¼‰ï¼Œè€Œæ˜¯åˆ†æ•£åˆ°æ¯æ¬¡æ“ä½œä¸­ï¼Œé¿å…äº†å¡é¡¿ã€‚

---

## ğŸ“š å­¦ä¹ è·¯çº¿æ€»ç»“

```
ç¬¬1å‘¨ï¼šåŸºç¡€å…¥é—¨
  âœ… å®‰è£… Redisï¼Œç†Ÿæ‚‰ redis-cli
  âœ… æŒæ¡ 5 ç§åŸºç¡€æ•°æ®ç±»å‹çš„å‘½ä»¤
  âœ… ç†è§£ TTLã€æŒä¹…åŒ–åŸºç¡€

ç¬¬2å‘¨ï¼šæ·±å…¥åŸç†
  âœ… RDB / AOF æŒä¹…åŒ–ç»†èŠ‚
  âœ… è¿‡æœŸç­–ç•¥ä¸å†…å­˜æ·˜æ±°
  âœ… äº‹åŠ¡å’Œ Lua è„šæœ¬
  âœ… åº•å±‚æ•°æ®ç»“æ„ï¼ˆè·³è¡¨ã€å‹ç¼©åˆ—è¡¨ç­‰ï¼‰

ç¬¬3å‘¨ï¼šå®æˆ˜åº”ç”¨
  âœ… ç¼“å­˜ç©¿é€/é›ªå´©/å‡»ç©¿çš„è§£å†³æ–¹æ¡ˆ
  âœ… åˆ†å¸ƒå¼é”å®æˆ˜
  âœ… Redis + MySQL æ•°æ®ä¸€è‡´æ€§
  âœ… ç”¨ C++ (hiredis) å†™ç®€å• Demo

ç¬¬4å‘¨ï¼šé«˜å¯ç”¨ä¸è¿ç»´
  âœ… ä¸»ä»å¤åˆ¶
  âœ… å“¨å…µæ¨¡å¼
  âœ… Redis Cluster
  âœ… ç›‘æ§ã€å¤§ Key æ’æŸ¥ã€æ€§èƒ½è°ƒä¼˜

æŒç»­æå‡ï¼š
  ğŸ“– é˜…è¯»ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹ï¼ˆé»„å¥å®è‘—ï¼‰
  ğŸ“– é˜…è¯» Redis å®˜æ–¹æ–‡æ¡£ https://redis.io/docs/
  ğŸ’» åœ¨é¡¹ç›®ä¸­å®è·µï¼Œé‡åˆ°é—®é¢˜å†æ·±æŒ–
```

---

> ğŸ’¡ **å†™ç»™æ–°æ‰‹çš„è¯**ï¼šå­¦ Redis æœ€é‡è¦çš„æ˜¯**åŠ¨æ‰‹å®è·µ**ã€‚æŠŠæ¯ç§æ•°æ®ç±»å‹çš„å‘½ä»¤éƒ½åœ¨ redis-cli é‡Œæ•²ä¸€éï¼Œç„¶åç”¨ C++ å†™ä¸€ä¸ªç®€å•çš„ç¼“å­˜ç³»ç»Ÿã€‚ç†è®ºç»“åˆå®æˆ˜ï¼Œæ‰èƒ½çœŸæ­£æŒæ¡ã€‚é‡åˆ°ä¸æ‡‚çš„å‘½ä»¤ï¼Œ`HELP @string`ã€`HELP SET` ç­‰å‘½ä»¤éƒ½èƒ½åœ¨ redis-cli é‡Œç›´æ¥æŸ¥æ–‡æ¡£ã€‚åŠ æ²¹ï¼ğŸš€